<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.42">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Piping and dplyr – MASTEMR</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-2f5df379a58b258e96c21c0638c20c03.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-baa83ea22f7c85f46c9cbd6ff4810be6.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="../css/mastemr.css">
</head>

<body class="nav-sidebar docked nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="../index.html" class="navbar-brand navbar-brand-logo">
    <img src="../images/KCL_logo.png" alt="" class="navbar-logo">
    </a>
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">MASTEMR</span>
    </a>
  </div>
        <div class="quarto-navbar-tools tools-end">
</div>
          <div id="quarto-search" class="" title="Search"></div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../chapters/02-1-Intro_to_analysis_software.html">02 Introduction to R</a></li><li class="breadcrumb-item"><a href="../chapters/02-3-Intro_to_analysis_software.html">Piping and dplyr</a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation docked overflow-auto">
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Home</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <span class="sidebar-item-text sidebar-link text-start">
 <span class="menu-text">Sessions</span></span>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/01-Intro_to_quant_methods.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">01 Introduction</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true">
 <span class="menu-text">02 Introduction to R</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/02-1-Intro_to_analysis_software.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Introduction to R</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/02-2-Intro_to_analysis_software.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Loading packages and exploring data</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/02-3-Intro_to_analysis_software.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Piping and dplyr</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/02-4-Intro_to_graphs.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Making graphs</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/03-Descriptive.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">03 Descriptive Statistics</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/04-Introduction_to_PISA.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">04 Introduction to PISA</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/05-Presentations.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">05 Presentations</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/06-T-testsPISA.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">06 T-tests</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/07-ChisqPISA.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">07 Hypothesis testing and Chi-square tests</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/08-Writing_report.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">08 Writing a quantitative report</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/09-Assignment_3_tutorials.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">09 Assignment 3 tutorials</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/10-Correlation_and_regression.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">10 Correlation and regression</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/11-selecting_statistical_tools.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">11 Selecting statistical tools</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/12-value_of_quant.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">12 The value of quantitative methods</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true">
 <span class="menu-text">Additional tests</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/A8-SEM.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">SEM</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true">
 <span class="menu-text">Appendicies</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/A1-PISA_analysis.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">PISA</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/A2-DfE_analysis.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">DfE England</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/A3-TIMSS_analysis.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">TIMSS, PIRLS and ICILS</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/A4-Other_datasets.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Other datasets</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/A5-Self_Study_Tasks.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Self Study Tasks</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/A6-QandA.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Questions and Answers</span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#select" id="toc-select" class="nav-link active" data-scroll-target="#select"><span class="header-section-number">1</span> select</a>
  <ul class="collapse">
  <li><a href="#questions" id="toc-questions" class="nav-link" data-scroll-target="#questions"><span class="header-section-number">1.1</span> Questions</a></li>
  </ul></li>
  <li><a href="#filter" id="toc-filter" class="nav-link" data-scroll-target="#filter"><span class="header-section-number">2</span> filter</a>
  <ul class="collapse">
  <li><a href="#questions-1" id="toc-questions-1" class="nav-link" data-scroll-target="#questions-1"><span class="header-section-number">2.1</span> Questions</a></li>
  </ul></li>
  <li><a href="#sec-renaming" id="toc-sec-renaming" class="nav-link" data-scroll-target="#sec-renaming"><span class="header-section-number">3</span> renaming columns</a></li>
  <li><a href="#group_by-and-summarise" id="toc-group_by-and-summarise" class="nav-link" data-scroll-target="#group_by-and-summarise"><span class="header-section-number">4</span> group_by and summarise</a>
  <ul class="collapse">
  <li><a href="#questions-2" id="toc-questions-2" class="nav-link" data-scroll-target="#questions-2"><span class="header-section-number">4.1</span> Questions</a></li>
  </ul></li>
  <li><a href="#sec-mutate" id="toc-sec-mutate" class="nav-link" data-scroll-target="#sec-mutate"><span class="header-section-number">5</span> mutate</a></li>
  <li><a href="#arrange" id="toc-arrange" class="nav-link" data-scroll-target="#arrange"><span class="header-section-number">6</span> arrange</a></li>
  <li><a href="#bring-everyting-together" id="toc-bring-everyting-together" class="nav-link" data-scroll-target="#bring-everyting-together"><span class="header-section-number">7</span> Bring everyting together</a></li>
  <li><a href="#advanced-topics" id="toc-advanced-topics" class="nav-link" data-scroll-target="#advanced-topics"><span class="header-section-number">8</span> Advanced topics</a>
  <ul class="collapse">
  <li><a href="#sec-ifelse" id="toc-sec-ifelse" class="nav-link" data-scroll-target="#sec-ifelse"><span class="header-section-number">8.1</span> Recoding data (ifelse)</a></li>
  <li><a href="#sec-factors" id="toc-sec-factors" class="nav-link" data-scroll-target="#sec-factors"><span class="header-section-number">8.2</span> Factors and statistical data types</a></li>
  </ul></li>
  <li><a href="#seminar-tasks" id="toc-seminar-tasks" class="nav-link" data-scroll-target="#seminar-tasks"><span class="header-section-number">9</span> Seminar tasks</a>
  <ul class="collapse">
  <li><a href="#student-dataset" id="toc-student-dataset" class="nav-link" data-scroll-target="#student-dataset"><span class="header-section-number">9.1</span> Student dataset</a></li>
  <li><a href="#teacher-dataset" id="toc-teacher-dataset" class="nav-link" data-scroll-target="#teacher-dataset"><span class="header-section-number">9.2</span> Teacher dataset</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../chapters/02-1-Intro_to_analysis_software.html">02 Introduction to R</a></li><li class="breadcrumb-item"><a href="../chapters/02-3-Intro_to_analysis_software.html">Piping and dplyr</a></li></ol></nav>
<div class="quarto-title">
<h1 class="title">Piping and dplyr</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>Piping allows us to break down complex tasks into manageable chunks that can be written and tested one after another. There are several powerful commands in the tidyverse as part of the <em>dplyr</em> package that can help us <code>group</code>, <code>filter</code>, <code>select</code>, <code>mutate</code> and <code>summarise</code> datasets. With this small set of commands we can use piping to convert massive datasets into simple and useful results.</p>
<p>Using the pipe <code>%&gt;%</code> command, we can feed the results from one command into the next command making for reusable and easy to read code.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/pipe_drawing.svg" class="img-fluid figure-img"></p>
<figcaption>how piping works</figcaption>
</figure>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>The pipe command we are using <code>%&gt;%</code> is from the <em>magrittr</em> package which is installed alongside the tidyverse. Recently <em>R</em> introduced another pipe <code>|&gt;</code> which offers very similar functionality and tutorials online might use either. The examples below use the <code>%&gt;%</code> pipe.</p>
</div>
</div>
<p>Let’s look at an example of using the pipe on the <code>PISA_2022</code> table to calculate the best performing OECD countries for maths <code>PV1MATH</code> by gender <code>ST004D01T</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="annotated-cell-1"><pre class="sourceCode numberSource r code-annotation-code number-lines code-with-copy code-annotated"><code class="sourceCode r"><a class="code-annotation-anchor" data-target-cell="annotated-cell-1" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-1-1" class="code-annotation-target"><a href="#annotated-cell-1-1"></a>PISA_2022 <span class="sc">%&gt;%</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-1" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-1-2" class="code-annotation-target"><a href="#annotated-cell-1-2"></a>  <span class="fu">filter</span>(OECD <span class="sc">==</span> <span class="st">"Yes"</span>) <span class="sc">%&gt;%</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-1" data-target-annotation="3" onclick="event.preventDefault();">3</a><span id="annotated-cell-1-3" class="code-annotation-target"><a href="#annotated-cell-1-3"></a>  <span class="fu">group_by</span>(CNT, ST004D01T) <span class="sc">%&gt;%</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-1" data-target-annotation="4" onclick="event.preventDefault();">4</a><span id="annotated-cell-1-4" class="code-annotation-target"><a href="#annotated-cell-1-4"></a>  <span class="fu">summarise</span>(<span class="at">mean_maths =</span> <span class="fu">mean</span>(PV1MATH, <span class="at">na.rm=</span><span class="cn">TRUE</span>),</span>
<span id="annotated-cell-1-5"><a href="#annotated-cell-1-5"></a>            <span class="at">sd_maths =</span> <span class="fu">sd</span>(PV1MATH, <span class="at">na.rm=</span><span class="cn">TRUE</span>),</span>
<span id="annotated-cell-1-6"><a href="#annotated-cell-1-6"></a>            <span class="at">students =</span> <span class="fu">n</span>()) <span class="sc">%&gt;%</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-1" data-target-annotation="5" onclick="event.preventDefault();">5</a><span id="annotated-cell-1-7" class="code-annotation-target"><a href="#annotated-cell-1-7"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(ST004D01T)) <span class="sc">%&gt;%</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-1" data-target-annotation="6" onclick="event.preventDefault();">6</a><span id="annotated-cell-1-8" class="code-annotation-target"><a href="#annotated-cell-1-8"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(mean_maths))</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-annotation">
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-1" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-1" data-code-lines="1" data-code-annotation="1">line 1 passes the whole <code>PISA_2022</code> dataset and pipes it into the next line using <code>%&gt;%</code></span>
</dd>
<dt data-target-cell="annotated-cell-1" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-1" data-code-lines="2" data-code-annotation="2">line 2 <code>filters</code> out any results that are from non-OECD countries by finding all the rows where <code>OECD</code> equals <code>==</code> “Yes”, this is then piped to the next line</span>
</dd>
<dt data-target-cell="annotated-cell-1" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-1" data-code-lines="3" data-code-annotation="3">line 3 groups the data by country <code>CNT</code> and by student gender <code>ST004D01T</code>, this is then piped to the next line</span>
</dd>
<dt data-target-cell="annotated-cell-1" data-target-annotation="4">4</dt>
<dd>
<span data-code-cell="annotated-cell-1" data-code-lines="4,5,6" data-code-annotation="4">line 4-6 the <code>summarise</code> command performs a calculation on the country and gender groupings returning three new columns, each command is described by code on a new line and separated by a comma: the mean value for maths <code>mean_maths</code>, the standard deviation <code>sd_maths</code>, and a column telling us how many students were in each grouping using the <code>n()</code> which returns the number of rows in a group. These new columns and the grouping columns are then piped to the next line, all other columns are dropped</span>
</dd>
<dt data-target-cell="annotated-cell-1" data-target-annotation="5">5</dt>
<dd>
<span data-code-cell="annotated-cell-1" data-code-lines="7" data-code-annotation="5">line 7 filters out any gender <code>ST004D01T</code> that is <code>NA</code>. First is finds all the students that have <code>NA</code> as their gender by using <code>is.na(ST004D01T)</code>, then it <em>NOTs</em>/flips the result using the exclamation mark <code>!</code>, giving those students who don’t have their gender set to <code>NA</code>. The filtered data is then piped to the next line</span>
</dd>
<dt data-target-cell="annotated-cell-1" data-target-annotation="6">6</dt>
<dd>
<span data-code-cell="annotated-cell-1" data-code-lines="8" data-code-annotation="6">line 8, finally we <code>arrange</code>/sort the results in <code>desc</code>ending order by the <code>mean_maths</code> column. The default for arrange is <em>ascending</em> order, leave out the <code>desc(  )</code> for the numbers to be ordered in the opposite way.</span>
</dd>
</dl>
</div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 74 × 5
# Groups:   CNT [37]
   CNT            ST004D01T mean_maths sd_maths students
   &lt;fct&gt;          &lt;fct&gt;          &lt;dbl&gt;    &lt;dbl&gt;    &lt;int&gt;
 1 Japan          Male            540.     99.0     2856
 2 Korea          Male            534.    112.      3325
 3 Japan          Female          531.     88.1     2904
 4 Korea          Female          528.     99.1     3129
 5 Estonia        Male            515.     87.4     3272
 6 Switzerland    Male            511.     99.3     3540
 7 Estonia        Female          510.     81.5     3120
 8 Czech Republic Male            502.    100.      4232
 9 Switzerland    Female          501.     90.9     3289
10 Austria        Male            500.     94.5     3110
# ℹ 64 more rows</code></pre>
</div>
</div>
<p>Across the top few countries, Males get a slightly better maths score <code>PV1MATH</code> than Females, other scores are available, please read <a href="../chapters/A1-PISA_analysis.html#sec-PV">§Plausible Values</a> to find out more about the limitations of using a “PV” value.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>we met the assignment command earlier <code>&lt;-</code>. Within the tidyverse commands we use the equals sign instead <code>=</code>.</p>
</div>
</div>
<p>The commands we have just used come from a package within the <code>tidyverse</code> called <code>dplyr</code>, let’s take a look at what they do:</p>
<table class="caption-top table">
<colgroup>
<col style="width: 33%">
<col style="width: 33%">
<col style="width: 33%">
</colgroup>
<thead>
<tr class="header">
<th>command</th>
<th>purpose</th>
<th>example</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>select</td>
<td>reduce the dataframe to the fields that you specify</td>
<td><code>select(&lt;field&gt;, &lt;field&gt;, &lt;field&gt;)</code></td>
</tr>
<tr class="even">
<td>filter</td>
<td>get rid of rows that don’t meet one or more criteria</td>
<td><code>filter(&lt;field&gt; &lt;comparison&gt;)</code></td>
</tr>
<tr class="odd">
<td>group</td>
<td>group fields together to perform calculations</td>
<td><code>group_by(&lt;field&gt;, &lt;field&gt;))</code></td>
</tr>
<tr class="even">
<td>mutate</td>
<td>add new fields or change values in current fields</td>
<td><code>mutate(&lt;new_field&gt; = &lt;field&gt; / 2)</code></td>
</tr>
<tr class="odd">
<td>summarise</td>
<td>create summary data optionally using a grouping command</td>
<td><code>summarise(&lt;new_field&gt; = max(&lt;field&gt;))</code></td>
</tr>
<tr class="even">
<td>arrange</td>
<td>order the results by one or more fields</td>
<td><code>arrange(desc(&lt;field&gt;))</code></td>
</tr>
</tbody>
</table>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>If you want to explore more of the functions of <code>dplyr</code>, take a look at the <a href="https://www.rstudio.com/wp-content/uploads/2015/02/data-wrangling-cheatsheet.pdf">helpsheet</a></p>
</div>
</div>
<div class="question">
<p>Adjust the code above to find out the lowest performing countries for reading <code>PV1READ</code> by gender that are not in the OECD</p>
<div class="cell">
<details class="code-fold">
<summary>answer</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1"></a>PISA_2022 <span class="sc">%&gt;%</span> </span>
<span id="cb2-2"><a href="#cb2-2"></a>  <span class="fu">filter</span>(OECD <span class="sc">==</span> <span class="st">"No"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb2-3"><a href="#cb2-3"></a>  <span class="fu">group_by</span>(CNT, ST004D01T) <span class="sc">%&gt;%</span> </span>
<span id="cb2-4"><a href="#cb2-4"></a>  <span class="fu">summarise</span>(<span class="at">mean_read =</span> <span class="fu">mean</span>(PV1READ, <span class="at">na.rm=</span><span class="cn">TRUE</span>),</span>
<span id="cb2-5"><a href="#cb2-5"></a>            <span class="at">sd_read =</span> <span class="fu">sd</span>(PV1READ, <span class="at">na.rm=</span><span class="cn">TRUE</span>),</span>
<span id="cb2-6"><a href="#cb2-6"></a>            <span class="at">students =</span> <span class="fu">n</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb2-7"><a href="#cb2-7"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(ST004D01T)) <span class="sc">%&gt;%</span></span>
<span id="cb2-8"><a href="#cb2-8"></a>  <span class="fu">arrange</span>(mean_read)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
<section id="select" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> select</h1>
<p>The <code>PISA_2022</code> dataset has far too many fields, to reduce the number of fields to focus on just a few of them we can use <code>select</code></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1"></a>PISA_2022 <span class="sc">%&gt;%</span> </span>
<span id="cb3-2"><a href="#cb3-2"></a>  <span class="fu">select</span>(CNT,ESCS, ST004D01T, ST003D02T)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 613,744 × 4
   CNT       ESCS ST004D01T ST003D02T
   &lt;fct&gt;    &lt;dbl&gt; &lt;fct&gt;     &lt;fct&gt;    
 1 Albania  1.11  Female    May      
 2 Albania -3.05  Male      February 
 3 Albania -0.187 Male      August   
 4 Albania -3.22  Female    July     
 5 Albania -1.05  Female    January  
 6 Albania  1.09  Male      May      
 7 Albania -0.762 Male      May      
 8 Albania -1.02  Female    December 
 9 Albania -1.17  Female    August   
10 Albania  0.286 Female    September
# ℹ 613,734 more rows</code></pre>
</div>
</div>
<p>You might also be in the situation where you want to select everything but one or two fields, you can do this with the negative signal <code>-</code>, the below code returns all the fields <em>except</em> <code>CNT</code> and <code>OECD</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1"></a>PISA_2022 <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="sc">-</span>CNT, <span class="sc">-</span>OECD)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 613,744 × 82
   CNTSCHID CNTSTUID REGION  LANGTEST_QQQ ST003D02T ST003D03T ST004D01T
      &lt;dbl&gt;    &lt;dbl&gt; &lt;fct&gt;   &lt;fct&gt;        &lt;fct&gt;     &lt;fct&gt;     &lt;fct&gt;    
 1   800282   800001 Albania Albanian     May       2006      Female   
 2   800115   800002 Albania Albanian     February  2006      Male     
 3   800242   800003 Albania Albanian     August    2006      Male     
 4   800245   800005 Albania Albanian     July      2006      Female   
 5   800285   800006 Albania Albanian     January   2006      Female   
 6   800172   800007 Albania Albanian     May       2006      Male     
 7   800082   800008 Albania Albanian     May       2006      Male     
 8   800274   800009 Albania Albanian     December  2006      Female   
 9   800057   800010 Albania Albanian     August    2006      Female   
10   800132   800012 Albania Albanian     September 2006      Female   
# ℹ 613,734 more rows
# ℹ 75 more variables: ST250Q01JA &lt;fct&gt;, ST250Q02JA &lt;fct&gt;, ST250Q03JA &lt;fct&gt;,
#   ST250Q05JA &lt;fct&gt;, ST251Q01JA &lt;fct&gt;, ST251Q06JA &lt;fct&gt;, ST251Q07JA &lt;fct&gt;,
#   ST253Q01JA &lt;fct&gt;, ST254Q01JA &lt;fct&gt;, ST254Q02JA &lt;fct&gt;, ST254Q03JA &lt;fct&gt;,
#   ST254Q04JA &lt;fct&gt;, ST254Q05JA &lt;fct&gt;, ST254Q06JA &lt;fct&gt;, ST255Q01JA &lt;fct&gt;,
#   ST256Q02JA &lt;fct&gt;, ST005Q01JA &lt;fct&gt;, ST007Q01JA &lt;fct&gt;, ST019AQ01T &lt;fct&gt;,
#   ST019BQ01T &lt;fct&gt;, ST019CQ01T &lt;fct&gt;, ST125Q01NA &lt;fct&gt;, ST261Q01JA &lt;fct&gt;, …</code></pre>
</div>
</div>
<p>You might find that you have a vector of column names that you want to select, to do this, we can use the <code>any_of</code> command:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1"></a>my_fields <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"CNT"</span>, <span class="st">"CNTSCHID"</span>, <span class="st">"ST004D01T"</span>)</span>
<span id="cb7-2"><a href="#cb7-2"></a>PISA_2022 <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="fu">any_of</span>(my_fields))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 613,744 × 3
   CNT     CNTSCHID ST004D01T
   &lt;fct&gt;      &lt;dbl&gt; &lt;fct&gt;    
 1 Albania   800282 Female   
 2 Albania   800115 Male     
 3 Albania   800242 Male     
 4 Albania   800245 Female   
 5 Albania   800285 Female   
 6 Albania   800172 Male     
 7 Albania   800082 Male     
 8 Albania   800274 Female   
 9 Albania   800057 Female   
10 Albania   800132 Female   
# ℹ 613,734 more rows</code></pre>
</div>
</div>
<p>With hundreds of fields available, you might want to focus on fields whose names match a certain pattern, to do this you can use <code>starts_with</code>, <code>ends_with</code>, <code>contains</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1"></a><span class="co"># country of birth of student, and father and mother are recorded in ST019___</span></span>
<span id="cb9-2"><a href="#cb9-2"></a>PISA_2022 <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="fu">starts_with</span>(<span class="st">"ST019"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 613,744 × 3
   ST019AQ01T      ST019BQ01T      ST019CQ01T     
   &lt;fct&gt;           &lt;fct&gt;           &lt;fct&gt;          
 1 Country of test Country of test Country of test
 2 Country of test Country of test Country of test
 3 Other country   Country of test Country of test
 4 Country of test Country of test Country of test
 5 Country of test Country of test Country of test
 6 Country of test Country of test Country of test
 7 Country of test Country of test Country of test
 8 Country of test Country of test Country of test
 9 Country of test Country of test Country of test
10 Country of test Country of test Country of test
# ℹ 613,734 more rows</code></pre>
</div>
</div>
<p>When you come to building your statistical models you often need to use <em>numeric</em> data, you can find the columns that have only numbers in them by the following. Be warned though, sometimes there are numeric fields which have a few words in them, so R treats them as characters. Use the PISA <a href="https://webfs.oecd.org/pisa2022/CY08MSP_CODEBOOK_5thDecember23.xlsx">codebook</a> to help work out where those numbers are.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1"></a>PISA_2022 <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="fu">where</span>(is.numeric)) <span class="sc">%&gt;%</span> <span class="fu">names</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "CNTSCHID"   "CNTSTUID"   "ST016Q01NA" "WB151Q01HA" "WB152Q01HA"
 [6] "WB156Q01HA" "BELONG"     "BULLIED"    "DISCLIM"    "HOMEPOS"   
[11] "ESCS"       "ATTCONFM"   "ICTEFFIC"   "STUBMI"     "PQMIMP"    
[16] "PARINVOL"   "W_FSTUWT"   "PV1MATH"    "PV1READ"    "PV1SCIE"   </code></pre>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>If you do want to change the type of a column to numeric you are going to need to:</p>
<ul>
<li><code>filter</code> out any offending rows, and</li>
<li><code>mutate</code> the column to be numeric: <code>col = as.numeric(col)</code></li>
</ul>
</div>
</div>
<section id="questions" class="level2" data-number="1.1">
<h2 data-number="1.1" class="anchored" data-anchor-id="questions"><span class="header-section-number">1.1</span> Questions</h2>
<div class="question">
<ol type="1">
<li>Spot the three errors with the following <code>select</code> statement</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1"></a>PISA_2022 </span>
<span id="cb13-2"><a href="#cb13-2"></a>  <span class="fu">select</span>(CNT BELONG) <span class="sc">%&gt;%</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<details class="code-fold">
<summary>answer</summary>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1"></a>PISA_2022 <span class="sc">%&gt;%</span>  <span class="co">#1 missing pipe</span></span>
<span id="cb14-2"><a href="#cb14-2"></a>  <span class="fu">select</span>(CNT, BELONG) <span class="co">#2 no comma between column names, #3 stray pipe on end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<ol start="2" type="1">
<li>Write a <code>select</code> statement to display the month <code>ST003D02T</code> and year of birth <code>ST003D03T</code> and the gender <code>ST004D01T</code> of each student.</li>
</ol>
<div class="cell">
<details class="code-fold">
<summary>answer</summary>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1"></a>PISA_2022 <span class="sc">%&gt;%</span> </span>
<span id="cb15-2"><a href="#cb15-2"></a>  <span class="fu">select</span>(ST003D02T, ST003D03T, ST004D01T)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<ol start="3" type="1">
<li>Write a <code>select</code> statement to show all the fields that are to do with well being and health, e.g.&nbsp;<code>WB150Q01HA</code> “How is your health?”</li>
</ol>
<div class="cell">
<details class="code-fold">
<summary>answer</summary>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1"></a>PISA_2022 <span class="sc">%&gt;%</span> </span>
<span id="cb16-2"><a href="#cb16-2"></a>  <span class="fu">select</span>(<span class="fu">starts_with</span>(<span class="st">"WB15"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<ol start="4" type="1">
<li>[EXTENSION] Adjust your answer to Q3 so that you select the gender <code>ST004D01T</code> and the ID <code>CNTSTUID</code> of each student in addition to the <code>ST254____</code> fields looking at digital devices in the home:</li>
</ol>
<div class="cell">
<details class="code-fold">
<summary>answer</summary>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1"></a>PISA_2022 <span class="sc">%&gt;%</span> </span>
<span id="cb17-2"><a href="#cb17-2"></a>  <span class="fu">select</span>(CNTSTUID, ST004D01T, <span class="fu">starts_with</span>(<span class="st">"ST254"</span>)) <span class="sc">%&gt;%</span> <span class="fu">na.omit</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
</section>
</section>
<section id="filter" class="level1" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> filter</h1>
<p>Not only does the <code>PISA_2022</code> dataset have a huge number of columns, it has hundred of thousands of rows. We want to <code>filter</code> this down to the students that we are interested in, i.e.&nbsp;filter out data that isn’t useful for our analysis. If we only wanted the results that were <code>Male</code>, we could do the following:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1"></a>PISA_2022 <span class="sc">%&gt;%</span> </span>
<span id="cb18-2"><a href="#cb18-2"></a>  <span class="fu">select</span>(CNT, ESCS, ST004D01T, ST003D02T, PV1MATH) <span class="sc">%&gt;%</span></span>
<span id="cb18-3"><a href="#cb18-3"></a>  <span class="fu">filter</span>(ST004D01T <span class="sc">==</span> <span class="st">"Male"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 307,906 × 5
   CNT       ESCS ST004D01T ST003D02T PV1MATH
   &lt;fct&gt;    &lt;dbl&gt; &lt;fct&gt;     &lt;fct&gt;       &lt;dbl&gt;
 1 Albania -3.05  Male      February     308.
 2 Albania -0.187 Male      August       268.
 3 Albania  1.09  Male      May          534.
 4 Albania -0.762 Male      May          382.
 5 Albania -1.98  Male      October      425.
 6 Albania  0.063 Male      April        463.
 7 Albania -0.170 Male      May          236.
 8 Albania -2.58  Male      August       327.
 9 Albania -1.09  Male      March        326.
10 Albania -0.334 Male      October      428.
# ℹ 307,896 more rows</code></pre>
</div>
</div>
<p>We can combine <code>filter</code> commands to look for <code>Males</code> born in <code>September</code> and where the <code>PV1MATH</code> figure is greater than <code>750</code>. We can list multiple criteria in the filter by separating the criteria with commas, using commas mean that all of these criteria need to be <code>TRUE</code> for a row to be returned. A comma in a filter is the equivalent of an <code>AND</code>, :</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1"></a>PISA_2022 <span class="sc">%&gt;%</span> </span>
<span id="cb20-2"><a href="#cb20-2"></a>  <span class="fu">select</span>(CNT, ESCS, ST004D01T, ST003D02T, PV1MATH) <span class="sc">%&gt;%</span></span>
<span id="cb20-3"><a href="#cb20-3"></a>  <span class="fu">filter</span>(ST004D01T <span class="sc">==</span> <span class="st">"Male"</span>,</span>
<span id="cb20-4"><a href="#cb20-4"></a>         ST003D02T <span class="sc">==</span> <span class="st">"September"</span>,</span>
<span id="cb20-5"><a href="#cb20-5"></a>         PV1MATH <span class="sc">&gt;</span> <span class="dv">750</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 52 × 5
   CNT             ESCS ST004D01T ST003D02T PV1MATH
   &lt;fct&gt;          &lt;dbl&gt; &lt;fct&gt;     &lt;fct&gt;       &lt;dbl&gt;
 1 Australia      0.994 Male      September    770.
 2 Australia      0.837 Male      September    758.
 3 Australia      1.22  Male      September    807.
 4 Canada         1.06  Male      September    752.
 5 Canada         1.04  Male      September    788.
 6 Canada         1.21  Male      September    781.
 7 Canada         0.804 Male      September    750.
 8 Chinese Taipei 0.842 Male      September    753.
 9 Chinese Taipei 0.488 Male      September    794.
10 Chinese Taipei 1.23  Male      September    794.
# ℹ 42 more rows</code></pre>
</div>
</div>
<p>You can also write it as an ampersand <code>&amp;</code></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1"></a>PISA_2022 <span class="sc">%&gt;%</span> </span>
<span id="cb22-2"><a href="#cb22-2"></a>  <span class="fu">select</span>(CNT, ESCS, ST004D01T, ST003D02T, PV1MATH) <span class="sc">%&gt;%</span></span>
<span id="cb22-3"><a href="#cb22-3"></a>  <span class="fu">filter</span>(ST004D01T <span class="sc">==</span> <span class="st">"Male"</span> <span class="sc">&amp;</span></span>
<span id="cb22-4"><a href="#cb22-4"></a>         ST003D02T <span class="sc">==</span> <span class="st">"September"</span> <span class="sc">&amp;</span></span>
<span id="cb22-5"><a href="#cb22-5"></a>         PV1MATH <span class="sc">&gt;</span> <span class="dv">750</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>Remember to include the <code>==</code> sign when looking to filter on equality; additionally, you can use <code>!=</code> (not equals), <code>&gt;=</code>, <code>&lt;=</code>, <code>&gt;</code>, <code>&lt;</code>.</p>
<p>Remember matching is case sensitive, “september” <code>!=</code> “September”</p>
</div>
</div>
<p>Rather than just looking at September born students, we want to find all the students born in the Autumn term. But if we add a couple more criteria on <code>ST003D02T</code> nothing is returned! Why?</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1"></a>PISA_2022 <span class="sc">%&gt;%</span> </span>
<span id="cb23-2"><a href="#cb23-2"></a>  <span class="fu">select</span>(CNT, ESCS, ST004D01T, ST003D02T, PV1MATH) <span class="sc">%&gt;%</span></span>
<span id="cb23-3"><a href="#cb23-3"></a>  <span class="fu">filter</span>(ST004D01T <span class="sc">==</span> <span class="st">"Male"</span>,</span>
<span id="cb23-4"><a href="#cb23-4"></a>         ST003D02T <span class="sc">==</span> <span class="st">"September"</span>,</span>
<span id="cb23-5"><a href="#cb23-5"></a>         ST003D02T <span class="sc">==</span> <span class="st">"October"</span>,</span>
<span id="cb23-6"><a href="#cb23-6"></a>         ST003D02T <span class="sc">==</span> <span class="st">"November"</span>,</span>
<span id="cb23-7"><a href="#cb23-7"></a>         ST003D02T <span class="sc">==</span> <span class="st">"December"</span>,</span>
<span id="cb23-8"><a href="#cb23-8"></a>         PV1MATH <span class="sc">&gt;</span> <span class="dv">750</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 0 × 5
# ℹ 5 variables: CNT &lt;fct&gt;, ESCS &lt;dbl&gt;, ST004D01T &lt;fct&gt;, ST003D02T &lt;fct&gt;,
#   PV1MATH &lt;dbl&gt;</code></pre>
</div>
</div>
<p>The reason is R is looking for individual students born in September <code>AND</code> October <code>AND</code> November <code>AND</code> December. As a student can only have one birth month there are no students that meet this criteria. We need to use <code>OR</code> :</p>
<p>To create an <code>OR</code> in a filter we use the bar <code>|</code> character, the below looks for all students who are “Male” <code>AND</code> were born in “September” <code>OR</code> “October” <code>OR</code> “November” <code>OR</code> “December”, <code>AND</code> have a <code>PV1MATH</code> &gt; 750.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1"></a>PISA_2022 <span class="sc">%&gt;%</span> </span>
<span id="cb25-2"><a href="#cb25-2"></a>  <span class="fu">select</span>(CNT, ESCS, ST004D01T, ST003D02T, PV1MATH) <span class="sc">%&gt;%</span></span>
<span id="cb25-3"><a href="#cb25-3"></a>  <span class="fu">filter</span>(ST004D01T <span class="sc">==</span> <span class="st">"Male"</span>,</span>
<span id="cb25-4"><a href="#cb25-4"></a>         (ST003D02T <span class="sc">==</span> <span class="st">"September"</span> <span class="sc">|</span> ST003D02T <span class="sc">==</span> <span class="st">"October"</span> <span class="sc">|</span> ST003D02T <span class="sc">==</span> <span class="st">"November"</span> <span class="sc">|</span> ST003D02T <span class="sc">==</span> <span class="st">"December"</span>),</span>
<span id="cb25-5"><a href="#cb25-5"></a>         PV1MATH <span class="sc">&gt;</span> <span class="dv">750</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 194 × 5
   CNT        ESCS ST004D01T ST003D02T PV1MATH
   &lt;fct&gt;     &lt;dbl&gt; &lt;fct&gt;     &lt;fct&gt;       &lt;dbl&gt;
 1 Australia 0.994 Male      September    770.
 2 Australia 1.03  Male      October      808.
 3 Australia 1.30  Male      October      762.
 4 Australia 1.21  Male      November     764.
 5 Australia 0.837 Male      September    758.
 6 Australia 1.22  Male      September    807.
 7 Belgium   0.746 Male      December     770.
 8 Belgium   0.939 Male      December     779.
 9 Belgium   1.25  Male      November     832.
10 Belgium   1.11  Male      October      776.
# ℹ 184 more rows</code></pre>
</div>
</div>
<p>It’s neater, maybe, to use the <code>%in%</code> command, which checks to see if the value in a column is present in a vector, this can mimic the <code>OR</code>/<code>|</code> command:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1"></a>PISA_2022 <span class="sc">%&gt;%</span> </span>
<span id="cb27-2"><a href="#cb27-2"></a>  <span class="fu">select</span>(CNT, ESCS, ST004D01T, ST003D02T, PV1MATH) <span class="sc">%&gt;%</span></span>
<span id="cb27-3"><a href="#cb27-3"></a>  <span class="fu">filter</span>(ST004D01T <span class="sc">==</span> <span class="st">"Male"</span>,</span>
<span id="cb27-4"><a href="#cb27-4"></a>         ST003D02T <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"September"</span>, <span class="st">"October"</span>, <span class="st">"November"</span>, <span class="st">"December"</span>),</span>
<span id="cb27-5"><a href="#cb27-5"></a>         PV1MATH <span class="sc">&gt;</span> <span class="dv">750</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>When building filters you need to know the range of values that a column can take, we can do this in several ways:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1"></a><span class="co"># show the possible levels</span></span>
<span id="cb28-2"><a href="#cb28-2"></a><span class="fu">levels</span>(PISA_2022<span class="sc">$</span>ST003D02T)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "January"        "February"       "March"          "April"         
 [5] "May"            "June"           "July"           "August"        
 [9] "September"      "October"        "November"       "December"      
[13] "Valid Skip"     "Not Applicable" "Invalid"        "No Response"   </code></pre>
</div>
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1"></a><span class="co"># show the actual unique values in a field</span></span>
<span id="cb30-2"><a href="#cb30-2"></a><span class="co"># this might be a slightly smaller set of values</span></span>
<span id="cb30-3"><a href="#cb30-3"></a><span class="fu">unique</span>(PISA_2022<span class="sc">$</span>ST003D02T)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] May       February  August    July      January   December  September
 [8] October   April     March     June      November  &lt;NA&gt;     
16 Levels: January February March April May June July August ... No Response</code></pre>
</div>
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1"></a><span class="co"># You might also want to read the label of a field</span></span>
<span id="cb32-2"><a href="#cb32-2"></a><span class="fu">attr</span>(PISA_2022<span class="sc">$</span>ST003D02T, <span class="st">"label"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Student (Standardized) Birth - Month"</code></pre>
</div>
</div>
</div>
</div>
<section id="questions-1" class="level2" data-number="2.1">
<h2 data-number="2.1" class="anchored" data-anchor-id="questions-1"><span class="header-section-number">2.1</span> Questions</h2>
<div class="question">
<ol type="1">
<li>Spot the <strong>two</strong> errors with the following <code>select</code> statement</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1"></a>PISA_2022</span>
<span id="cb34-2"><a href="#cb34-2"></a>  <span class="fu">select</span>(CNT, PV1READ) <span class="sc">%&gt;%</span></span>
<span id="cb34-3"><a href="#cb34-3"></a>  <span class="fu">filter</span>(<span class="at">CNT =</span> <span class="st">"Finland"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<details class="code-fold">
<summary>answer</summary>
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1"></a>PISA_2022 <span class="sc">%&gt;%</span>  <span class="co">#1 missing pipe command</span></span>
<span id="cb35-2"><a href="#cb35-2"></a>  <span class="fu">select</span>(CNT, PV1READ) <span class="sc">%&gt;%</span></span>
<span id="cb35-3"><a href="#cb35-3"></a>  <span class="fu">filter</span>(CNT <span class="sc">==</span> <span class="st">"Finland"</span>) <span class="co">#2 you need a double equals</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<ol start="2" type="1">
<li>Use <code>filter</code> to find all the students with <code>PV1READ</code> grade equal to 333.</li>
</ol>
<div class="cell">
<details class="code-fold">
<summary>answer</summary>
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1"></a>PISA_2022 <span class="sc">%&gt;%</span> </span>
<span id="cb36-2"><a href="#cb36-2"></a>  <span class="fu">filter</span>(PV1READ <span class="sc">==</span> <span class="dv">333</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<ol start="3" type="1">
<li>Use <code>filter</code> to find all the students with <code>PV1READ</code>, <code>PV1SCIE</code>, and <code>PV1MATH</code> grades over 800.</li>
</ol>
<div class="cell">
<details class="code-fold">
<summary>answer</summary>
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1"></a>PISA_2022 <span class="sc">%&gt;%</span> </span>
<span id="cb37-2"><a href="#cb37-2"></a>  <span class="fu">filter</span>(PV1READ <span class="sc">&gt;</span> <span class="dv">800</span>,</span>
<span id="cb37-3"><a href="#cb37-3"></a>         PV1SCIE <span class="sc">&gt;</span> <span class="dv">800</span>,</span>
<span id="cb37-4"><a href="#cb37-4"></a>         PV1MATH <span class="sc">&gt;</span> <span class="dv">800</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<ol start="4" type="1">
<li>Spot the <strong>three</strong> errors with the following <code>select</code> statement</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1"></a>PISA_2022 <span class="sc">%&gt;%</span> </span>
<span id="cb38-2"><a href="#cb38-2"></a>  <span class="fu">select</span>(CNT) <span class="sc">%&gt;%</span></span>
<span id="cb38-3"><a href="#cb38-3"></a>  <span class="fu">filter</span>(CNT <span class="cf">in</span> <span class="fu">c</span>(<span class="st">"France"</span>, <span class="st">"belgium"</span>)</span>
<span id="cb38-4"><a href="#cb38-4"></a>         ESCS <span class="sc">&lt;</span> <span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<details class="code-fold">
<summary>answer</summary>
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1"></a>PISA_2022 <span class="sc">%&gt;%</span> </span>
<span id="cb39-2"><a href="#cb39-2"></a>  <span class="fu">select</span>(CNT, ESCS) <span class="sc">%&gt;%</span> <span class="co">#1 you have ESCS in the filter, it needs to be in the select as well</span></span>
<span id="cb39-3"><a href="#cb39-3"></a>  <span class="fu">filter</span>(CNT <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"France"</span>, <span class="st">"Belgium"</span>), <span class="co">#2 Belgium needs a capital letter</span></span>
<span id="cb39-4"><a href="#cb39-4"></a>                                          <span class="co">#3 the %in% command needs percentages</span></span>
<span id="cb39-5"><a href="#cb39-5"></a>                                          <span class="co">#4 you need a comma (or &amp;) at the end of the line</span></span>
<span id="cb39-6"><a href="#cb39-6"></a>         ESCS <span class="sc">&lt;</span> <span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<ol start="5" type="1">
<li>Use <code>filter</code> to find all the students with <code>Three or more</code> cars in their home <code>ST251Q01JA</code>. How does this compare to those with no <code>None</code> cars?</li>
</ol>
<div class="cell">
<details class="code-fold">
<summary>answer</summary>
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1"></a><span class="co"># cars 3+ </span></span>
<span id="cb40-2"><a href="#cb40-2"></a>PISA_2022 <span class="sc">%&gt;%</span></span>
<span id="cb40-3"><a href="#cb40-3"></a>  <span class="fu">select</span>(CNT, ST251Q01JA) <span class="sc">%&gt;%</span></span>
<span id="cb40-4"><a href="#cb40-4"></a>  <span class="fu">filter</span>(ST251Q01JA <span class="sc">==</span> <span class="st">"Three or more"</span>)</span>
<span id="cb40-5"><a href="#cb40-5"></a></span>
<span id="cb40-6"><a href="#cb40-6"></a><span class="co"># cars 0</span></span>
<span id="cb40-7"><a href="#cb40-7"></a>PISA_2022 <span class="sc">%&gt;%</span></span>
<span id="cb40-8"><a href="#cb40-8"></a>  <span class="fu">select</span>(CNT, ST251Q01JA) <span class="sc">%&gt;%</span></span>
<span id="cb40-9"><a href="#cb40-9"></a>  <span class="fu">filter</span>(ST251Q01JA <span class="sc">==</span> <span class="st">"None"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<ol start="6" type="1">
<li>Adjust your code in Q2. to find the number of students with <code>Three or more</code> cars in their home <code>ST251Q01JA</code> in <code>Italy</code>, how does this compare with <code>Spain</code>?</li>
</ol>
<div class="cell">
<details class="code-fold">
<summary>answer</summary>
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1"></a>PISA_2022 <span class="sc">%&gt;%</span></span>
<span id="cb41-2"><a href="#cb41-2"></a>  <span class="fu">select</span>(CNT, ST251Q01JA) <span class="sc">%&gt;%</span></span>
<span id="cb41-3"><a href="#cb41-3"></a>  <span class="fu">filter</span>(ST251Q01JA <span class="sc">==</span> <span class="st">"Three or more"</span>,</span>
<span id="cb41-4"><a href="#cb41-4"></a>         CNT <span class="sc">==</span> <span class="st">"Italy"</span>)</span>
<span id="cb41-5"><a href="#cb41-5"></a></span>
<span id="cb41-6"><a href="#cb41-6"></a>PISA_2022 <span class="sc">%&gt;%</span></span>
<span id="cb41-7"><a href="#cb41-7"></a>  <span class="fu">select</span>(CNT, ST251Q01JA) <span class="sc">%&gt;%</span></span>
<span id="cb41-8"><a href="#cb41-8"></a>  <span class="fu">filter</span>(ST251Q01JA <span class="sc">==</span> <span class="st">"Three or more"</span>,</span>
<span id="cb41-9"><a href="#cb41-9"></a>         CNT <span class="sc">==</span> <span class="st">"Spain"</span>)</span>
<span id="cb41-10"><a href="#cb41-10"></a></span>
<span id="cb41-11"><a href="#cb41-11"></a><span class="co"># EXTENSION:</span></span>
<span id="cb41-12"><a href="#cb41-12"></a><span class="co"># Note we would need to know the percentage of students </span></span>
<span id="cb41-13"><a href="#cb41-13"></a><span class="co"># in each country with that number of cars to make a proper</span></span>
<span id="cb41-14"><a href="#cb41-14"></a><span class="co"># comparison. Spain might have more students taking the PISA</span></span>
<span id="cb41-15"><a href="#cb41-15"></a><span class="co"># test than Italy, or vice-versa</span></span>
<span id="cb41-16"><a href="#cb41-16"></a></span>
<span id="cb41-17"><a href="#cb41-17"></a>PISA_2022 <span class="sc">%&gt;%</span></span>
<span id="cb41-18"><a href="#cb41-18"></a>  <span class="fu">select</span>(CNT, ST251Q01JA) <span class="sc">%&gt;%</span></span>
<span id="cb41-19"><a href="#cb41-19"></a>  <span class="fu">filter</span>(CNT <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Italy"</span>, <span class="st">"Spain"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb41-20"><a href="#cb41-20"></a>  <span class="fu">group_by</span>(CNT) <span class="sc">%&gt;%</span></span>
<span id="cb41-21"><a href="#cb41-21"></a>  <span class="fu">mutate</span>(<span class="at">total_stus =</span> <span class="fu">n</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb41-22"><a href="#cb41-22"></a>  <span class="fu">filter</span>(ST251Q01JA <span class="sc">==</span> <span class="st">"Three or more"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb41-23"><a href="#cb41-23"></a>  <span class="fu">summarise</span>(<span class="at">three_more =</span> <span class="fu">n</span>(),</span>
<span id="cb41-24"><a href="#cb41-24"></a>            <span class="at">per_three_more =</span> three_more<span class="sc">/</span><span class="fu">unique</span>(total_stus))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<ol start="7" type="1">
<li>Write a <code>filter</code> to create a table for the number of <code>Female</code> students with reading <code>PV1READ</code> scores lower than 400 in the <code>United Kingdom</code>, store the result as <code>read_low_female</code>, repeat but for <code>Male</code> students and store as <code>read_low_male</code>. Use <code>nrow()</code> to work out if there are more males or females with a low reading score in the UK</li>
</ol>
<div class="cell">
<details class="code-fold">
<summary>answer</summary>
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1"></a>read_low_female <span class="ot">&lt;-</span> PISA_2022 <span class="sc">%&gt;%</span> </span>
<span id="cb42-2"><a href="#cb42-2"></a>  <span class="fu">filter</span>(CNT <span class="sc">==</span> <span class="st">"United Kingdom"</span>,</span>
<span id="cb42-3"><a href="#cb42-3"></a>         PV1READ <span class="sc">&lt;</span> <span class="dv">400</span>,</span>
<span id="cb42-4"><a href="#cb42-4"></a>         ST004D01T <span class="sc">==</span> <span class="st">"Female"</span>)</span>
<span id="cb42-5"><a href="#cb42-5"></a></span>
<span id="cb42-6"><a href="#cb42-6"></a>read_low_male <span class="ot">&lt;-</span> PISA_2022 <span class="sc">%&gt;%</span> </span>
<span id="cb42-7"><a href="#cb42-7"></a>  <span class="fu">filter</span>(CNT <span class="sc">==</span> <span class="st">"United Kingdom"</span>,</span>
<span id="cb42-8"><a href="#cb42-8"></a>         PV1READ <span class="sc">&lt;</span> <span class="dv">400</span>,</span>
<span id="cb42-9"><a href="#cb42-9"></a>         ST004D01T <span class="sc">==</span> <span class="st">"Male"</span>)</span>
<span id="cb42-10"><a href="#cb42-10"></a></span>
<span id="cb42-11"><a href="#cb42-11"></a><span class="fu">nrow</span>(read_low_female)</span>
<span id="cb42-12"><a href="#cb42-12"></a><span class="fu">nrow</span>(read_low_male)</span>
<span id="cb42-13"><a href="#cb42-13"></a></span>
<span id="cb42-14"><a href="#cb42-14"></a><span class="co"># You could also pipe the whole dataframe into nrow()</span></span>
<span id="cb42-15"><a href="#cb42-15"></a>PISA_2022 <span class="sc">%&gt;%</span> </span>
<span id="cb42-16"><a href="#cb42-16"></a>  <span class="fu">filter</span>(CNT <span class="sc">==</span> <span class="st">"United Kingdom"</span>,</span>
<span id="cb42-17"><a href="#cb42-17"></a>         PV1READ <span class="sc">&lt;</span> <span class="dv">400</span>,</span>
<span id="cb42-18"><a href="#cb42-18"></a>         ST004D01T <span class="sc">==</span> <span class="st">"Female"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb42-19"><a href="#cb42-19"></a>  <span class="fu">nrow</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<ol start="8" type="1">
<li>How many students in the United Kingdom had no television <code>ST254Q01JA</code> <em>OR</em> no connection to the internet <code>ST250Q05JA</code>. <strong>HINT</strong>: use <code>levels(PISA_2022$ST254Q01JA)</code> to look at the levels available for each column.</li>
</ol>
<div class="cell">
<details class="code-fold">
<summary>answer</summary>
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1"></a>PISA_2022 <span class="sc">%&gt;%</span> <span class="fu">filter</span>(CNT <span class="sc">==</span> <span class="st">"United Kingdom"</span>, </span>
<span id="cb43-2"><a href="#cb43-2"></a>                     ST254Q01JA <span class="sc">==</span> <span class="st">"None"</span> <span class="sc">|</span></span>
<span id="cb43-3"><a href="#cb43-3"></a>                     ST250Q05JA <span class="sc">==</span> <span class="st">"None"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<ol start="9" type="1">
<li>Which countr[y|ies] had students with <code>NA</code> for Gender, remember to check for <code>NA</code> using <code>is.na()</code>?</li>
</ol>
<div class="cell">
<details class="code-fold">
<summary>answer</summary>
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1"></a>PISA_2022 <span class="sc">%&gt;%</span> </span>
<span id="cb44-2"><a href="#cb44-2"></a>  <span class="fu">filter</span>(<span class="fu">is.na</span>(ST004D01T)) <span class="sc">%&gt;%</span></span>
<span id="cb44-3"><a href="#cb44-3"></a>  <span class="fu">select</span>(CNT) <span class="sc">%&gt;%</span></span>
<span id="cb44-4"><a href="#cb44-4"></a>  <span class="fu">distinct</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
</section>
</section>
<section id="sec-renaming" class="level1" data-number="3">
<h1 data-number="3"><span class="header-section-number">3</span> renaming columns</h1>
<p>Very often when dealing with datasets such as PISA or TIMSS, the column names can be very confusing without a reference key, e.g.&nbsp;<code>ST004D01T</code>, <code>OCOD3</code> and <code>ST261Q04JA</code>. To rename columns in the tidyverse we use the <code>rename(&lt;new_name&gt; = &lt;old_name&gt;)</code> command. For example, if you wanted to rename the rather confusingly named student column for <em>gender</em>, also known as <code>ST004D01T</code>, and the column for having a <em>having enough digital resources</em> in school, also known as <code>IC172Q01JA</code>, you could use:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1"></a>PISA_2022 <span class="sc">%&gt;%</span></span>
<span id="cb45-2"><a href="#cb45-2"></a>  <span class="fu">rename</span>(<span class="at">gender =</span> ST004D01T,</span>
<span id="cb45-3"><a href="#cb45-3"></a>         <span class="at">dig_resources =</span> IC172Q01JA) <span class="sc">%&gt;%</span></span>
<span id="cb45-4"><a href="#cb45-4"></a>  <span class="fu">select</span>(CNT, gender, dig_resources) <span class="sc">%&gt;%</span> </span>
<span id="cb45-5"><a href="#cb45-5"></a>  <span class="fu">summary</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                   CNT                    gender      
 Spain               : 30800   Female        :305759  
 United Arab Emirates: 24600   Male          :307906  
 Canada              : 23073   Valid Skip    :     0  
 Kazakhstan          : 19769   Not Applicable:     0  
 Indonesia           : 13439   Invalid       :     0  
 Australia           : 13437   No Response   :     0  
 (Other)             :488626   NA's          :    79  
           dig_resources   
 Agree            :183233  
 Disagree         : 70595  
 Strongly agree   : 49276  
 Strongly disagree: 35223  
 Valid Skip       :     0  
 (Other)          :     0  
 NA's             :275417  </code></pre>
</div>
</div>
<p>If you want to change the name of the column so that it stays when you need to perform another calculation, remember to <em>assign</em> the renamed dataframe back to the original dataframe. But be warned, you’ll need to reload the full dataset to restore the original names:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1"></a>PISA_2022 <span class="ot">&lt;-</span> PISA_2022 <span class="sc">%&gt;%</span></span>
<span id="cb47-2"><a href="#cb47-2"></a>    <span class="fu">rename</span>(<span class="at">gender =</span> ST004D01T,</span>
<span id="cb47-3"><a href="#cb47-3"></a>           <span class="at">dig_resources =</span> IC172Q01JA)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="group_by-and-summarise" class="level1" data-number="4">
<h1 data-number="4"><span class="header-section-number">4</span> group_by and summarise</h1>
<p>So far we have looked at ways to return rows that meet certain criteria. Using <code>group_by</code> and <code>summarise</code> we can start to analyse data for different groups of students. For example, let’s look at the number of students who don’t have internet connections at home besides a mobile phone <code>ST250Q05JA</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="annotated-cell-15"><pre class="sourceCode numberSource r code-annotation-code number-lines code-with-copy code-annotated"><code class="sourceCode r"><a class="code-annotation-anchor" data-target-cell="annotated-cell-15" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-15-1" class="code-annotation-target"><a href="#annotated-cell-15-1"></a>PISA_2022 <span class="sc">%&gt;%</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-15" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-15-2" class="code-annotation-target"><a href="#annotated-cell-15-2"></a>  <span class="fu">group_by</span>(ST250Q05JA) <span class="sc">%&gt;%</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-15" data-target-annotation="3" onclick="event.preventDefault();">3</a><span id="annotated-cell-15-3" class="code-annotation-target"><a href="#annotated-cell-15-3"></a>  <span class="fu">summarise</span>(<span class="at">student_n =</span> <span class="fu">n</span>())</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-annotation">
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-15" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-15" data-code-lines="1" data-code-annotation="1">Line 1 passes the full <code>PISA_2022</code> to the pipe</span>
</dd>
<dt data-target-cell="annotated-cell-15" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-15" data-code-lines="2" data-code-annotation="2">Line 2 makes groups within <code>PISA_2022</code> using the unique values of <code>ST250Q05JA</code></span>
</dd>
<dt data-target-cell="annotated-cell-15" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-15" data-code-lines="3" data-code-annotation="3">Line 3, these groups are then passed to <code>summarise</code>, which creates a new column called <code>student_n</code> and stores the number of rows in each <code>ST250Q05JA</code> group using the <code>n()</code> command. <code>summarise</code> only returns the columns it creates, or are in the <code>group_by</code>, everything else is discarded.</span>
</dd>
</dl>
</div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 2
  ST250Q05JA student_n
  &lt;fct&gt;          &lt;int&gt;
1 Yes           525842
2 No             56968
3 &lt;NA&gt;           30934</code></pre>
</div>
</div>
<p>What we might want to do is look at this data from a country by country perspective, by adding another field to the <code>group_by()</code> command, we then group by the unique combination of countries <code>CNT</code> and internet access <code>ST250Q05JA</code>, e.g.&nbsp;Albania + Yes; Albania + No; Albania + NA; United Arab Emirates + Yes; etc</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1"></a>int_by_cnt <span class="ot">&lt;-</span> PISA_2022 <span class="sc">%&gt;%</span> </span>
<span id="cb49-2"><a href="#cb49-2"></a>  <span class="fu">group_by</span>(CNT, ST250Q05JA) <span class="sc">%&gt;%</span></span>
<span id="cb49-3"><a href="#cb49-3"></a>  <span class="fu">summarise</span>(<span class="at">student_n =</span> <span class="fu">n</span>())</span>
<span id="cb49-4"><a href="#cb49-4"></a></span>
<span id="cb49-5"><a href="#cb49-5"></a><span class="fu">print</span>(int_by_cnt)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 238 × 3
# Groups:   CNT [80]
   CNT                  ST250Q05JA student_n
   &lt;fct&gt;                &lt;fct&gt;          &lt;int&gt;
 1 Albania              Yes             4693
 2 Albania              No               535
 3 Albania              &lt;NA&gt;             901
 4 United Arab Emirates Yes            22206
 5 United Arab Emirates No              1116
 6 United Arab Emirates &lt;NA&gt;            1278
 7 Argentina            Yes            10484
 8 Argentina            No               938
 9 Argentina            &lt;NA&gt;             689
10 Australia            Yes            12808
# ℹ 228 more rows</code></pre>
</div>
</div>
<p><code>summarise</code> can also be used to work out statistics by grouping. For example, if you wanted to find out the <code>max</code>, <code>mean</code> and <code>min</code> science grade <code>PV1SCIE</code> by country <code>CNT</code>, you could do the following:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1"></a>PISA_2022 <span class="sc">%&gt;%</span> </span>
<span id="cb51-2"><a href="#cb51-2"></a>  <span class="fu">group_by</span>(CNT) <span class="sc">%&gt;%</span></span>
<span id="cb51-3"><a href="#cb51-3"></a>  <span class="fu">summarise</span>(<span class="at">sci_max  =</span> <span class="fu">max</span>(PV1SCIE,  <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb51-4"><a href="#cb51-4"></a>            <span class="at">sci_mean =</span> <span class="fu">mean</span>(PV1SCIE, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb51-5"><a href="#cb51-5"></a>            <span class="at">sci_min  =</span> <span class="fu">min</span>(PV1SCIE,  <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 80 × 4
   CNT                  sci_max sci_mean sci_min
   &lt;fct&gt;                  &lt;dbl&gt;    &lt;dbl&gt;   &lt;dbl&gt;
 1 Albania                 724.     376.    74.6
 2 United Arab Emirates    842.     436.     0  
 3 Argentina               751.     415.   128. 
 4 Australia               875.     508.   108. 
 5 Austria                 804.     494.   170. 
 6 Belgium                 792.     495.   169. 
 7 Bulgaria                728.     422.   130. 
 8 Brazil                  784.     406.   106. 
 9 Brunei Darussalam       762.     445.   135. 
10 Canada                  893.     499.   107. 
# ℹ 70 more rows</code></pre>
</div>
</div>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p><code>group_by()</code> can have unintended consequences in your code if you are saving your pipes to new dataframes. To be safe your can clear any grouping by adding: <code>my_data %&gt;% ungroup()</code></p>
</div>
</div>
<section id="questions-2" class="level2" data-number="4.1">
<h2 data-number="4.1" class="anchored" data-anchor-id="questions-2"><span class="header-section-number">4.1</span> Questions</h2>
<div class="question">
<ol type="1">
<li>Spot the <strong>three</strong> errors with the following <code>summarise</code> statement</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1"></a>PISA_2022 <span class="sc">%&gt;%</span> </span>
<span id="cb53-2"><a href="#cb53-2"></a>  <span class="fu">group</span>(CNT)</span>
<span id="cb53-3"><a href="#cb53-3"></a>  <span class="fu">summarise</span>(<span class="at">num_stus =</span> n)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<details class="code-fold">
<summary>answer</summary>
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1"></a>PISA_2022 <span class="sc">%&gt;%</span> </span>
<span id="cb54-2"><a href="#cb54-2"></a>  <span class="fu">group_by</span>(CNT) <span class="sc">%&gt;%</span> <span class="co">#1 group_by NOT group #2 missing pipe %&gt;%</span></span>
<span id="cb54-3"><a href="#cb54-3"></a>  <span class="fu">summarise</span>(<span class="at">num_stus =</span> <span class="fu">n</span>()) <span class="co">#3 = n() not = n</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<ol start="2" type="1">
<li>Write a <code>group_by</code> and <code>summarise</code> statement to work out the <code>mean</code> and <code>median</code> cultural capital value <code>ESCS</code> for each student by country <code>CNT</code></li>
</ol>
<div class="cell">
<details class="code-fold">
<summary>answer</summary>
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1"></a>PISA_2022 <span class="sc">%&gt;%</span></span>
<span id="cb55-2"><a href="#cb55-2"></a>  <span class="fu">group_by</span>(CNT) <span class="sc">%&gt;%</span></span>
<span id="cb55-3"><a href="#cb55-3"></a>  <span class="fu">summarise</span>(<span class="at">escs_mean =</span> <span class="fu">mean</span>(ESCS, <span class="at">na.rm=</span><span class="cn">TRUE</span>),</span>
<span id="cb55-4"><a href="#cb55-4"></a>            <span class="at">escs_median =</span> <span class="fu">median</span>(ESCS, <span class="at">na.rm=</span><span class="cn">TRUE</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<ol start="3" type="1">
<li>Using <code>summarise</code> work out, <code>Yes</code> or <code>No</code>, by country <code>CNT</code> and gender <code>ST004D01T</code>, whether students “Agree/disagree: There are enough [digital resources] for every student at my school” <code>IC172Q01JA</code>. Filter out any <code>NA</code> values on <code>IC172Q01JA</code>:</li>
</ol>
<div class="cell">
<details class="code-fold">
<summary>answer</summary>
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1"></a>PISA_2022 <span class="sc">%&gt;%</span> </span>
<span id="cb56-2"><a href="#cb56-2"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(IC172Q01JA)) <span class="sc">%&gt;%</span></span>
<span id="cb56-3"><a href="#cb56-3"></a>  <span class="fu">group_by</span>(CNT, ST004D01T, IC172Q01JA) <span class="sc">%&gt;%</span> </span>
<span id="cb56-4"><a href="#cb56-4"></a>  <span class="fu">summarise</span>(<span class="at">n=</span><span class="fu">n</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
</section>
</section>
<section id="sec-mutate" class="level1" data-number="5">
<h1 data-number="5"><span class="header-section-number">5</span> mutate</h1>
<p>Sometimes you will want to adjust the values stored in a field, e.g.&nbsp;converting a distance in miles into kilometres; or compute a new fields based on other fields, e.g.&nbsp;working out a total grade given the parts of a test. To do this we can use <code>mutate</code>. Unlike <code>summarise</code>, <code>mutate</code> retains all the other columns either adding a new column or changing an existing one</p>
<blockquote class="blockquote">
<p><code>mutate(&lt;field&gt; = &lt;field_calculation&gt;)</code></p>
</blockquote>
<p>The <code>PISA_2022</code> dataset has results for maths <code>PV1MATH</code>, science <code>PV1SCIE</code> and reading <code>PV1READ</code>. We could combine these to create an overall <code>PISA_grade</code>, and <code>PISA_mean</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="annotated-cell-18"><pre class="sourceCode numberSource r code-annotation-code number-lines code-with-copy code-annotated"><code class="sourceCode r"><span id="annotated-cell-18-1"><a href="#annotated-cell-18-1"></a>PISA_2022 <span class="sc">%&gt;%</span>                                       </span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-18" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-18-2" class="code-annotation-target"><a href="#annotated-cell-18-2"></a>  <span class="fu">mutate</span>(<span class="at">PV1_total =</span> PV1MATH <span class="sc">+</span> PV1SCIE <span class="sc">+</span> PV1READ,</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-18" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-18-3" class="code-annotation-target"><a href="#annotated-cell-18-3"></a>         <span class="at">PV1_mean =</span> PV1_total<span class="sc">/</span><span class="dv">3</span>) <span class="sc">%&gt;%</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-18" data-target-annotation="3" onclick="event.preventDefault();">3</a><span id="annotated-cell-18-4" class="code-annotation-target"><a href="#annotated-cell-18-4"></a>  <span class="fu">select</span>(CNT, ST004D01T, ESCS, PV1_total, PV1_mean)</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-annotation">
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-18" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-18" data-code-lines="2" data-code-annotation="1"><code>mutate</code> creates a new field called <code>PV1_total</code> made up by adding together the columns for maths, science and reading. Each column acts like a vector and adding them together is the equivalent of adding each students individual grades together, row by row. See <a href="../chapters/02-1-Intro_to_analysis_software.html#sec-vectors">§Vectors</a> for more details on vector addition.</span>
</dd>
<dt data-target-cell="annotated-cell-18" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-18" data-code-lines="3" data-code-annotation="2">inside the same <code>mutate</code> statement, we take the <code>PV1_total</code> calculated on line two and divide it by 3, to give us a mean value, this is then assigned to a new column, <code>PV1_mean</code>.</span>
</dd>
<dt data-target-cell="annotated-cell-18" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-18" data-code-lines="4" data-code-annotation="3">this line <code>select</code>s only the fields that we are interested in, dropping the others</span>
</dd>
</dl>
</div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 613,744 × 5
   CNT     ST004D01T   ESCS PV1_total PV1_mean
   &lt;fct&gt;   &lt;fct&gt;      &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;
 1 Albania Female     1.11       763.     254.
 2 Albania Male      -3.05       882.     294.
 3 Albania Male      -0.187      911.     304.
 4 Albania Female    -3.22       809.     270.
 5 Albania Female    -1.05      1335.     445.
 6 Albania Male       1.09      1464.     488.
 7 Albania Male      -0.762     1115.     372.
 8 Albania Female    -1.02       904.     301.
 9 Albania Female    -1.17      1145.     382.
10 Albania Female     0.286     1235.     412.
# ℹ 613,734 more rows</code></pre>
</div>
</div>
<p>We can use <code>mutate</code> to create subsets of data in fields. For example, if we wanted to see how many students in each country were high performing readers, specified by getting a reading grade of greater than <code>550</code>, we could do the following:</p>
<div class="cell">
<div class="sourceCode cell-code" id="annotated-cell-19"><pre class="sourceCode numberSource r code-annotation-code number-lines code-with-copy code-annotated"><code class="sourceCode r"><span id="annotated-cell-19-1"><a href="#annotated-cell-19-1"></a>PISA_2022 <span class="sc">%&gt;%</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-19" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-19-2" class="code-annotation-target"><a href="#annotated-cell-19-2"></a>  <span class="fu">mutate</span>(<span class="at">PV1READ_high =</span> PV1READ <span class="sc">&gt;</span> <span class="dv">550</span>) <span class="sc">%&gt;%</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-19" data-target-annotation="3" onclick="event.preventDefault();">3</a><span id="annotated-cell-19-3" class="code-annotation-target"><a href="#annotated-cell-19-3"></a>  <span class="fu">group_by</span>(CNT, PV1READ_high) <span class="sc">%&gt;%</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-19" data-target-annotation="4" onclick="event.preventDefault();">4</a><span id="annotated-cell-19-4" class="code-annotation-target"><a href="#annotated-cell-19-4"></a>  <span class="fu">summarise</span>(<span class="at">n =</span> <span class="fu">n</span>())</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-annotation">
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-19" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-19" data-code-lines="2" data-code-annotation="2">this line creates a new column called <code>PV1READ_high</code> for every students, storing a boolean value, <code>TRUE</code> or <code>FALSE</code> depending on whether their reading grates <code>PV1READ</code> &gt; 550.</span>
</dd>
<dt data-target-cell="annotated-cell-19" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-19" data-code-lines="3" data-code-annotation="3">a grouping is made on the country and the new field <code>PV1READ_high</code>, e.g.&nbsp;Albania + TRUE, Albania + FALSE, etc.</span>
</dd>
<dt data-target-cell="annotated-cell-19" data-target-annotation="4">4</dt>
<dd>
<span data-code-cell="annotated-cell-19" data-code-lines="4" data-code-annotation="4">using summarise we can find the number of student rows in each grouping using <code>n()</code>, and drop all the other fields</span>
</dd>
</dl>
</div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 159 × 3
# Groups:   CNT [80]
   CNT                  PV1READ_high     n
   &lt;fct&gt;                &lt;lgl&gt;        &lt;int&gt;
 1 Albania              FALSE         6055
 2 Albania              TRUE            74
 3 United Arab Emirates FALSE        20711
 4 United Arab Emirates TRUE          3889
 5 Argentina            FALSE        11197
 6 Argentina            TRUE           914
 7 Australia            FALSE         9005
 8 Australia            TRUE          4432
 9 Austria              FALSE         4461
10 Austria              TRUE          1690
# ℹ 149 more rows</code></pre>
</div>
</div>
<p>Comparisons can also be made between different columns, if we wanted to find out the percentage of Males and Females that got a better grade in their maths test <code>PV1MATH</code> than in their reading test <code>PV1READ</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="annotated-cell-20"><pre class="sourceCode numberSource r code-annotation-code number-lines code-with-copy code-annotated"><code class="sourceCode r"><span id="annotated-cell-20-1"><a href="#annotated-cell-20-1"></a>PISA_2022 <span class="sc">%&gt;%</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-20" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-20-2" class="code-annotation-target"><a href="#annotated-cell-20-2"></a>  <span class="fu">mutate</span>(<span class="at">maths_better =</span> PV1MATH <span class="sc">&gt;</span> PV1READ) <span class="sc">%&gt;%</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-20" data-target-annotation="3" onclick="event.preventDefault();">3</a><span id="annotated-cell-20-3" class="code-annotation-target"><a href="#annotated-cell-20-3"></a>  <span class="fu">select</span>(CNT, ST004D01T, maths_better, PV1MATH, PV1READ) <span class="sc">%&gt;%</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-20" data-target-annotation="4" onclick="event.preventDefault();">4</a><span id="annotated-cell-20-4" class="code-annotation-target"><a href="#annotated-cell-20-4"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(ST004D01T), <span class="sc">!</span><span class="fu">is.na</span>(maths_better)) <span class="sc">%&gt;%</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-20" data-target-annotation="5" onclick="event.preventDefault();">5</a><span id="annotated-cell-20-5" class="code-annotation-target"><a href="#annotated-cell-20-5"></a>  <span class="fu">group_by</span>(ST004D01T) <span class="sc">%&gt;%</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-20" data-target-annotation="6" onclick="event.preventDefault();">6</a><span id="annotated-cell-20-6" class="code-annotation-target"><a href="#annotated-cell-20-6"></a>  <span class="fu">mutate</span>(<span class="at">students_n =</span> <span class="fu">n</span>()) <span class="sc">%&gt;%</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-20" data-target-annotation="7" onclick="event.preventDefault();">7</a><span id="annotated-cell-20-7" class="code-annotation-target"><a href="#annotated-cell-20-7"></a>  <span class="fu">group_by</span>(ST004D01T, maths_better) <span class="sc">%&gt;%</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-20" data-target-annotation="8" onclick="event.preventDefault();">8</a><span id="annotated-cell-20-8" class="code-annotation-target"><a href="#annotated-cell-20-8"></a>  <span class="fu">summarise</span>(<span class="at">n =</span> <span class="fu">n</span>(),</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-20" data-target-annotation="9" onclick="event.preventDefault();">9</a><span id="annotated-cell-20-9" class="code-annotation-target"><a href="#annotated-cell-20-9"></a>            <span class="at">per =</span> n<span class="sc">/</span><span class="fu">unique</span>(students_n))</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-annotation">
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-20" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-20" data-code-lines="2" data-code-annotation="2"><code>mutate</code> creates a new field called <code>maths_better</code> made up by comparing the <code>PV1MATH</code> grade with <code>PV1READ</code> and creating a boolean/logical vector for the column.</span>
</dd>
<dt data-target-cell="annotated-cell-20" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-20" data-code-lines="3" data-code-annotation="3"><code>select</code>s a subset of the columns</span>
</dd>
<dt data-target-cell="annotated-cell-20" data-target-annotation="4">4</dt>
<dd>
<span data-code-cell="annotated-cell-20" data-code-lines="4" data-code-annotation="4"><code>filter</code>s out any students that don’t have gender data <code>ST004D01T</code> <em>and</em> where the calculation on line 2 failed, i.e.&nbsp;<code>PV1MATH</code> or <code>PV1READ</code> was <code>NA</code></span>
</dd>
<dt data-target-cell="annotated-cell-20" data-target-annotation="5">5</dt>
<dd>
<span data-code-cell="annotated-cell-20" data-code-lines="5" data-code-annotation="5"><code>group</code> on the gender of the student</span>
</dd>
<dt data-target-cell="annotated-cell-20" data-target-annotation="6">6</dt>
<dd>
<span data-code-cell="annotated-cell-20" data-code-lines="6" data-code-annotation="6">using the <code>group</code> on line 5, use <code>mutate</code> to calculate the total number of Males and Females by looking for the number of rows in each group <code>n()</code>, store this as <code>students_n</code></span>
</dd>
<dt data-target-cell="annotated-cell-20" data-target-annotation="7">7</dt>
<dd>
<span data-code-cell="annotated-cell-20" data-code-lines="7" data-code-annotation="7">re-<code>group</code> the data on gender <code>ST004D01T</code> and whether the student is better at maths than reading <code>maths_better</code></span>
</dd>
<dt data-target-cell="annotated-cell-20" data-target-annotation="8">8</dt>
<dd>
<span data-code-cell="annotated-cell-20" data-code-lines="8" data-code-annotation="8">count the number of students, <code>n</code> in each group specified by line 7.</span>
</dd>
<dt data-target-cell="annotated-cell-20" data-target-annotation="9">9</dt>
<dd>
<span data-code-cell="annotated-cell-20" data-code-lines="9" data-code-annotation="9">create a percentage figure for the number of students in each grouping given by line 7. Use the <code>n</code> value from line 8 and the <code>students_n</code> value from line 6. <strong>NOTE:</strong> we need to use <code>unique(students_n)</code> to return just one value for each grouping rather than a value for every row of the line 7 grouping</span>
</dd>
</dl>
</div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 × 4
# Groups:   ST004D01T [2]
  ST004D01T maths_better      n   per
  &lt;fct&gt;     &lt;lgl&gt;         &lt;int&gt; &lt;dbl&gt;
1 Female    FALSE        180350 0.590
2 Female    TRUE         125409 0.410
3 Male      FALSE        118341 0.384
4 Male      TRUE         189565 0.616</code></pre>
</div>
</div>
<p>For more information on how to <code>mutate</code> fields using <code>ifelse</code>, see <a href="#sec-ifelse" class="quarto-xref">Section&nbsp;8.1</a></p>
</section>
<section id="arrange" class="level1" data-number="6">
<h1 data-number="6"><span class="header-section-number">6</span> arrange</h1>
<p>The results returned by pipes can be huge, so it’s a good idea to store them in objects and explore them in the Environment window where you can sort and search within the output. There might also be times when you want to order/<code>arrange</code> the outputs in a particular way. We can do this quite easily in the tidyverse by using the <code>arrange(&lt;column_name&gt;, &lt;column_name&gt;)</code> function.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1"></a>PISA_2022 <span class="sc">%&gt;%</span></span>
<span id="cb60-2"><a href="#cb60-2"></a>  <span class="fu">select</span>(CNT, ST004D01T, PV1MATH) <span class="sc">%&gt;%</span></span>
<span id="cb60-3"><a href="#cb60-3"></a>  <span class="fu">arrange</span>(PV1MATH)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 613,744 × 3
   CNT       ST004D01T PV1MATH
   &lt;fct&gt;     &lt;fct&gt;       &lt;dbl&gt;
 1 Cambodia  Male          0  
 2 Guatemala Female       57.8
 3 Cambodia  Female       84.7
 4 Cambodia  Male         87.9
 5 Cambodia  Male         88.6
 6 Paraguay  Male         90.4
 7 Cambodia  Male         94.4
 8 Cambodia  Female       98.0
 9 Albania   Male         99.7
10 Cambodia  Female      100. 
# ℹ 613,734 more rows</code></pre>
</div>
</div>
<p>If we’re interested in the highest achieving students we can add the <code>desc()</code> function to <code>arrange</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1"></a>PISA_2022 <span class="sc">%&gt;%</span></span>
<span id="cb62-2"><a href="#cb62-2"></a>  <span class="fu">select</span>(CNT, LANGN, ST004D01T, PV1MATH) <span class="sc">%&gt;%</span></span>
<span id="cb62-3"><a href="#cb62-3"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(PV1MATH))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 613,744 × 4
   CNT               LANGN     ST004D01T PV1MATH
   &lt;fct&gt;             &lt;fct&gt;     &lt;fct&gt;       &lt;dbl&gt;
 1 Singapore         Invalid   Male         943.
 2 Chinese Taipei    Mandarin  Male         917.
 3 Singapore         Invalid   Male         897.
 4 Korea             Korean    Male         893.
 5 Korea             Korean    Female       889.
 6 Chinese Taipei    Mandarin  Male         887.
 7 Singapore         Invalid   Male         883.
 8 Hong Kong (China) Cantonese Male         880.
 9 Korea             Korean    Male         868.
10 Singapore         Invalid   Male         867.
# ℹ 613,734 more rows</code></pre>
</div>
</div>
</section>
<section id="bring-everyting-together" class="level1" data-number="7">
<h1 data-number="7"><span class="header-section-number">7</span> Bring everyting together</h1>
<p>We know that the <a href="https://educationendowmentfoundation.org.uk/education-evidence/teaching-learning-toolkit/repeating-a-year">evidence</a> strongly indicates that repeating a year is not good for student progress, but how do countries around the world differ in terms of the percentage of their students who repeat a year?</p>
<div class="cell">
<div class="sourceCode cell-code" id="annotated-cell-23"><pre class="sourceCode numberSource r code-annotation-code number-lines code-with-copy code-annotated"><code class="sourceCode r"><a class="code-annotation-anchor" data-target-cell="annotated-cell-23" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-23-1" class="code-annotation-target"><a href="#annotated-cell-23-1"></a>data_repeat <span class="ot">&lt;-</span> PISA_2022 <span class="sc">%&gt;%</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-23" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-23-2" class="code-annotation-target"><a href="#annotated-cell-23-2"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(REPEAT)) <span class="sc">%&gt;%</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-23" data-target-annotation="3" onclick="event.preventDefault();">3</a><span id="annotated-cell-23-3" class="code-annotation-target"><a href="#annotated-cell-23-3"></a>  <span class="fu">group_by</span>(CNT) <span class="sc">%&gt;%</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-23" data-target-annotation="4" onclick="event.preventDefault();">4</a><span id="annotated-cell-23-4" class="code-annotation-target"><a href="#annotated-cell-23-4"></a>  <span class="fu">mutate</span>(<span class="at">total =</span> <span class="fu">n</span>()) <span class="sc">%&gt;%</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-23" data-target-annotation="5" onclick="event.preventDefault();">5</a><span id="annotated-cell-23-5" class="code-annotation-target"><a href="#annotated-cell-23-5"></a>  <span class="fu">select</span>(CNT, REPEAT, total) <span class="sc">%&gt;%</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-23" data-target-annotation="6" onclick="event.preventDefault();">6</a><span id="annotated-cell-23-6" class="code-annotation-target"><a href="#annotated-cell-23-6"></a>  <span class="fu">group_by</span>(CNT, REPEAT) <span class="sc">%&gt;%</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-23" data-target-annotation="7" onclick="event.preventDefault();">7</a><span id="annotated-cell-23-7" class="code-annotation-target"><a href="#annotated-cell-23-7"></a>  <span class="fu">summarise</span>(<span class="at">student_n =</span> <span class="fu">n</span>(),</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-23" data-target-annotation="8" onclick="event.preventDefault();">8</a><span id="annotated-cell-23-8" class="code-annotation-target"><a href="#annotated-cell-23-8"></a>            <span class="at">total =</span> <span class="fu">unique</span>(total),</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-23" data-target-annotation="9" onclick="event.preventDefault();">9</a><span id="annotated-cell-23-9" class="code-annotation-target"><a href="#annotated-cell-23-9"></a>            <span class="at">per =</span> student_n <span class="sc">/</span> <span class="fu">unique</span>(total)) <span class="sc">%&gt;%</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-23" data-target-annotation="10" onclick="event.preventDefault();">10</a><span id="annotated-cell-23-10" class="code-annotation-target"><a href="#annotated-cell-23-10"></a>  <span class="fu">filter</span>(REPEAT <span class="sc">==</span> <span class="st">"Repeated at lease once"</span>) <span class="sc">%&gt;%</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-23" data-target-annotation="11" onclick="event.preventDefault();">11</a><span id="annotated-cell-23-11" class="code-annotation-target"><a href="#annotated-cell-23-11"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(per))</span>
<span id="annotated-cell-23-12"><a href="#annotated-cell-23-12"></a></span>
<span id="annotated-cell-23-13"><a href="#annotated-cell-23-13"></a><span class="fu">print</span>(data_repeat)                                  </span>
<span id="annotated-cell-23-14"><a href="#annotated-cell-23-14"></a></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-23" data-target-annotation="12" onclick="event.preventDefault();">12</a><span id="annotated-cell-23-15" class="code-annotation-target"><a href="#annotated-cell-23-15"></a><span class="fu">write_csv</span>(data_repeat, <span class="st">"&lt;folder_location&gt;/repeat_a_year.csv"</span>)</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-annotation">
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-23" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-23" data-code-lines="1" data-code-annotation="1">uses the <code>PISA_2022</code> dataframe, note that this line includes <code>&lt;-</code> to store the result opf the piping into a new object called <code>data_repeat</code></span>
</dd>
<dt data-target-cell="annotated-cell-23" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-23" data-code-lines="2" data-code-annotation="2"><code>filter</code> out any <code>NA</code> values in the <code>REPEAT</code> field</span>
</dd>
<dt data-target-cell="annotated-cell-23" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-23" data-code-lines="3" data-code-annotation="3">group on the country of student <code>CNT</code></span>
</dd>
<dt data-target-cell="annotated-cell-23" data-target-annotation="4">4</dt>
<dd>
<span data-code-cell="annotated-cell-23" data-code-lines="4" data-code-annotation="4">create a new column <code>total</code> for total number of rows <code>n()</code> in each country <code>CNT</code> grouping</span>
</dd>
<dt data-target-cell="annotated-cell-23" data-target-annotation="5">5</dt>
<dd>
<span data-code-cell="annotated-cell-23" data-code-lines="5" data-code-annotation="5">select on the <code>CNT</code>, <code>REPEAT</code> and <code>total</code> columns</span>
</dd>
<dt data-target-cell="annotated-cell-23" data-target-annotation="6">6</dt>
<dd>
<span data-code-cell="annotated-cell-23" data-code-lines="6" data-code-annotation="6">regroup the data on country <code>CNT</code> and whether a student has repeated a year <code>REPEAT</code>, i.e.&nbsp;Albania+Did not repeat a grade; Albania+Repeated a grade; etc.</span>
</dd>
<dt data-target-cell="annotated-cell-23" data-target-annotation="7">7</dt>
<dd>
<span data-code-cell="annotated-cell-23" data-code-lines="7" data-code-annotation="7">using the above grouping, count the number of rows in each group <code>n()</code> and assign this to <code>student_n</code></span>
</dd>
<dt data-target-cell="annotated-cell-23" data-target-annotation="8">8</dt>
<dd>
<span data-code-cell="annotated-cell-23" data-code-lines="8" data-code-annotation="8">for each grouping keep the <code>total</code> number of students in each country, as calculated on line 4. Note: <code>unique(total)</code> is needed here to return a single value of <code>total</code>, rather than a value for each student in each country</span>
</dd>
<dt data-target-cell="annotated-cell-23" data-target-annotation="9">9</dt>
<dd>
<span data-code-cell="annotated-cell-23" data-code-lines="9" data-code-annotation="9">using <code>student_n</code> from line 7 and the number of students per country <code>total</code>, from line 4, create a percentage <code>per</code> for each grouping</span>
</dd>
<dt data-target-cell="annotated-cell-23" data-target-annotation="10">10</dt>
<dd>
<span data-code-cell="annotated-cell-23" data-code-lines="10" data-code-annotation="10">as we have percentages for both <code>Repeated at lease once</code> and <code>Never repeated</code>, we only need to display one of these.</span>
</dd>
<dt data-target-cell="annotated-cell-23" data-target-annotation="11">11</dt>
<dd>
<span data-code-cell="annotated-cell-23" data-code-lines="11" data-code-annotation="11">finally, we sort the data on the per/percentage column, to show the countries with the highest level of repeating a grade. This data is self-recorded by students, so might not be totally reliable!</span>
</dd>
<dt data-target-cell="annotated-cell-23" data-target-annotation="12">12</dt>
<dd>
<span data-code-cell="annotated-cell-23" data-code-lines="15" data-code-annotation="12">save the data to your own folder as a csv</span>
</dd>
</dl>
</div>
</div>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 78 × 5
# Groups:   CNT [78]
   CNT                REPEAT                 student_n total   per
   &lt;fct&gt;              &lt;fct&gt;                      &lt;int&gt; &lt;int&gt; &lt;dbl&gt;
 1 Morocco            Repeated at lease once      3156  6796 0.464
 2 Colombia           Repeated at lease once      2783  7401 0.376
 3 Cambodia           Repeated at lease once      1697  5156 0.329
 4 Guatemala          Repeated at lease once      1382  5110 0.270
 5 Panama             Repeated at lease once      1050  4080 0.257
 6 Philippines        Repeated at lease once      1793  7071 0.254
 7 Dominican Republic Repeated at lease once      1603  6566 0.244
 8 Belgium            Repeated at lease once      1941  8055 0.241
 9 Jamaica            Repeated at lease once       851  3600 0.236
10 Netherlands        Repeated at lease once      1118  4858 0.230
# ℹ 68 more rows</code></pre>
</div>
</div>
</section>
<section id="advanced-topics" class="level1" data-number="8">
<h1 data-number="8"><span class="header-section-number">8</span> Advanced topics</h1>
<section id="sec-ifelse" class="level2" data-number="8.1">
<h2 data-number="8.1" class="anchored" data-anchor-id="sec-ifelse"><span class="header-section-number">8.1</span> Recoding data (ifelse)</h2>
<p>Often we want to plot values in groupings that don’t yet exist, for example might want to give all schools over a certain size a different <em>colour</em> from others schools, or flag up students who have a different home language to the language that is being taught in school. To do this we need to look at how we can <em>recode</em> values. A common way to recode values is through an <code>ifelse</code> statement:</p>
<blockquote class="blockquote">
<p><code>ifelse(&lt;statement(s)&gt;, &lt;value_if_true&gt;, &lt;value_if_false&gt;)</code></p>
</blockquote>
<p><code>ifelse</code> allows us to <em>recode</em> the data. In the example below, we are going to add a new column to the <code>PISA_2022</code> dataset (using <code>mutate</code>) noting whether a student got a higher grade in their Maths <code>PV1MATH</code> or Reading <code>PV1READ</code> tests. <strong>if</strong> <code>PV1MATH</code> is bigger then <code>PV1READ</code>, the <code>maths_better</code> is <code>TRUE</code>, <strong>else</strong> <code>maths_better</code> is <code>FALSE</code>, or in <code>dplyr</code> format:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1"></a>maths_data <span class="ot">&lt;-</span> PISA_2022 <span class="sc">%&gt;%</span></span>
<span id="cb65-2"><a href="#cb65-2"></a>  <span class="fu">mutate</span>(<span class="at">maths_better =</span> </span>
<span id="cb65-3"><a href="#cb65-3"></a>           <span class="fu">ifelse</span>(PV1MATH <span class="sc">&gt;</span> PV1READ,</span>
<span id="cb65-4"><a href="#cb65-4"></a>                  <span class="cn">TRUE</span>, </span>
<span id="cb65-5"><a href="#cb65-5"></a>                  <span class="cn">FALSE</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb65-6"><a href="#cb65-6"></a>  <span class="fu">select</span>(CNT, ST004D01T, maths_better, PV1MATH, PV1READ)</span>
<span id="cb65-7"><a href="#cb65-7"></a></span>
<span id="cb65-8"><a href="#cb65-8"></a><span class="fu">print</span>(maths_data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 613,744 × 5
   CNT     ST004D01T maths_better PV1MATH PV1READ
   &lt;fct&gt;   &lt;fct&gt;     &lt;lgl&gt;          &lt;dbl&gt;   &lt;dbl&gt;
 1 Albania Female    FALSE           180.    248.
 2 Albania Male      TRUE            308.    258.
 3 Albania Male      FALSE           268.    285.
 4 Albania Female    FALSE           273.    322.
 5 Albania Female    FALSE           435.    464.
 6 Albania Male      TRUE            534.    451.
 7 Albania Male      FALSE           382.    391.
 8 Albania Female    FALSE           273.    308.
 9 Albania Female    FALSE           355.    429.
10 Albania Female    TRUE            430.    420.
# ℹ 613,734 more rows</code></pre>
</div>
</div>
<p>We now take this new dataset <code>maths_data</code> and look at whether the difference between relative performance in maths and reading is the same for girls and boys:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1"></a>maths_data <span class="sc">%&gt;%</span> </span>
<span id="cb67-2"><a href="#cb67-2"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(ST004D01T), <span class="sc">!</span><span class="fu">is.na</span>(maths_better)) <span class="sc">%&gt;%</span></span>
<span id="cb67-3"><a href="#cb67-3"></a>  <span class="fu">group_by</span>(ST004D01T, maths_better) <span class="sc">%&gt;%</span></span>
<span id="cb67-4"><a href="#cb67-4"></a>  <span class="fu">summarise</span>(<span class="at">n =</span> <span class="fu">n</span>()) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 × 3
# Groups:   ST004D01T [2]
  ST004D01T maths_better      n
  &lt;fct&gt;     &lt;lgl&gt;         &lt;int&gt;
1 Female    FALSE        180350
2 Female    TRUE         125409
3 Male      FALSE        118341
4 Male      TRUE         189565</code></pre>
</div>
</div>
<div class="question">
<p>Adjust the code above to work out the percentages of Males and Females <code>ST004D01T</code> in each group. Check to see if the pattern also exists between science <code>PV1SCIE</code> and reading <code>PV1READ</code>:</p>
<div class="cell">
<details class="code-fold">
<summary>adding percentage column</summary>
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1"></a>PISA_2022 <span class="sc">%&gt;%</span></span>
<span id="cb69-2"><a href="#cb69-2"></a>  <span class="fu">mutate</span>(<span class="at">maths_better =</span> </span>
<span id="cb69-3"><a href="#cb69-3"></a>           <span class="fu">ifelse</span>(PV1MATH <span class="sc">&gt;</span> PV1READ,</span>
<span id="cb69-4"><a href="#cb69-4"></a>                  <span class="cn">TRUE</span>, </span>
<span id="cb69-5"><a href="#cb69-5"></a>                  <span class="cn">FALSE</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb69-6"><a href="#cb69-6"></a>  <span class="fu">select</span>(CNT, ST004D01T, maths_better, PV1MATH, PV1READ) <span class="sc">%&gt;%</span> </span>
<span id="cb69-7"><a href="#cb69-7"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(ST004D01T), <span class="sc">!</span><span class="fu">is.na</span>(maths_better)) <span class="sc">%&gt;%</span></span>
<span id="cb69-8"><a href="#cb69-8"></a>  <span class="fu">group_by</span>(ST004D01T) <span class="sc">%&gt;%</span></span>
<span id="cb69-9"><a href="#cb69-9"></a>  <span class="fu">mutate</span>(<span class="at">students_n =</span> <span class="fu">n</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb69-10"><a href="#cb69-10"></a>  <span class="fu">group_by</span>(ST004D01T, maths_better) <span class="sc">%&gt;%</span></span>
<span id="cb69-11"><a href="#cb69-11"></a>  <span class="fu">summarise</span>(<span class="at">n =</span> <span class="fu">n</span>(),</span>
<span id="cb69-12"><a href="#cb69-12"></a>            <span class="at">per =</span> n<span class="sc">/</span><span class="fu">unique</span>(students_n))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold">
<summary>comparing science and reading</summary>
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1"></a>PISA_2022 <span class="sc">%&gt;%</span></span>
<span id="cb70-2"><a href="#cb70-2"></a>  <span class="fu">mutate</span>(<span class="at">sci_better =</span> </span>
<span id="cb70-3"><a href="#cb70-3"></a>           <span class="fu">ifelse</span>(PV1SCIE <span class="sc">&gt;</span> PV1READ,</span>
<span id="cb70-4"><a href="#cb70-4"></a>                  <span class="cn">TRUE</span>, </span>
<span id="cb70-5"><a href="#cb70-5"></a>                  <span class="cn">FALSE</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb70-6"><a href="#cb70-6"></a>  <span class="fu">select</span>(CNT, ST004D01T, sci_better, PV1SCIE, PV1READ) <span class="sc">%&gt;%</span> </span>
<span id="cb70-7"><a href="#cb70-7"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(ST004D01T), <span class="sc">!</span><span class="fu">is.na</span>(sci_better)) <span class="sc">%&gt;%</span></span>
<span id="cb70-8"><a href="#cb70-8"></a>  <span class="fu">group_by</span>(ST004D01T) <span class="sc">%&gt;%</span></span>
<span id="cb70-9"><a href="#cb70-9"></a>  <span class="fu">mutate</span>(<span class="at">students_n =</span> <span class="fu">n</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb70-10"><a href="#cb70-10"></a>  <span class="fu">group_by</span>(ST004D01T, sci_better) <span class="sc">%&gt;%</span></span>
<span id="cb70-11"><a href="#cb70-11"></a>  <span class="fu">summarise</span>(<span class="at">n =</span> <span class="fu">n</span>(),</span>
<span id="cb70-12"><a href="#cb70-12"></a>            <span class="at">per =</span> n<span class="sc">/</span><span class="fu">unique</span>(students_n))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold">
<summary>comparing science and maths</summary>
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1"></a>PISA_2022 <span class="sc">%&gt;%</span></span>
<span id="cb71-2"><a href="#cb71-2"></a>  <span class="fu">mutate</span>(<span class="at">sci_better =</span> </span>
<span id="cb71-3"><a href="#cb71-3"></a>           <span class="fu">ifelse</span>(PV1SCIE <span class="sc">&gt;</span> PV1MATH,</span>
<span id="cb71-4"><a href="#cb71-4"></a>                  <span class="cn">TRUE</span>, </span>
<span id="cb71-5"><a href="#cb71-5"></a>                  <span class="cn">FALSE</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb71-6"><a href="#cb71-6"></a>  <span class="fu">select</span>(CNT, ST004D01T, sci_better, PV1SCIE, PV1MATH) <span class="sc">%&gt;%</span> </span>
<span id="cb71-7"><a href="#cb71-7"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(ST004D01T), <span class="sc">!</span><span class="fu">is.na</span>(sci_better)) <span class="sc">%&gt;%</span></span>
<span id="cb71-8"><a href="#cb71-8"></a>  <span class="fu">group_by</span>(ST004D01T) <span class="sc">%&gt;%</span></span>
<span id="cb71-9"><a href="#cb71-9"></a>  <span class="fu">mutate</span>(<span class="at">students_n =</span> <span class="fu">n</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb71-10"><a href="#cb71-10"></a>  <span class="fu">group_by</span>(ST004D01T, sci_better) <span class="sc">%&gt;%</span></span>
<span id="cb71-11"><a href="#cb71-11"></a>  <span class="fu">summarise</span>(<span class="at">n =</span> <span class="fu">n</span>(),</span>
<span id="cb71-12"><a href="#cb71-12"></a>            <span class="at">per =</span> n<span class="sc">/</span><span class="fu">unique</span>(students_n))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
<p><code>ifelse</code> statements can get a little complicated when using factors (see: <a href="#sec-factors" class="quarto-xref">Section&nbsp;8.2</a>). Take this example. Let’s flag students who have a different home language <code>LANGN</code> to the language that is being used in the PISA assessment tool <code>LANGTEST_QQQ</code>. We make an assumption here that the assessment tool will be the language used at school, so these students will be learning in a different language to their mother tongue. <strong>if</strong> <code>LANGN</code> equals <code>LANGTEST_QQQ</code>, the <code>lang_diff</code> is <code>FALSE</code>, <strong>else</strong> <code>lang_diff</code> is <code>TRUE</code>, this raises an error:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb72-1"><a href="#cb72-1"></a>lang_data <span class="ot">&lt;-</span> PISA_2022 <span class="sc">%&gt;%</span></span>
<span id="cb72-2"><a href="#cb72-2"></a>  <span class="fu">mutate</span>(<span class="at">lang_diff =</span> </span>
<span id="cb72-3"><a href="#cb72-3"></a>           <span class="fu">ifelse</span>(LANGN <span class="sc">==</span> LANGTEST_QQQ,</span>
<span id="cb72-4"><a href="#cb72-4"></a>                  <span class="cn">FALSE</span>, </span>
<span id="cb72-5"><a href="#cb72-5"></a>                  <span class="cn">TRUE</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb72-6"><a href="#cb72-6"></a>  <span class="fu">select</span>(CNT, lang_diff, LANGTEST_QQQ, LANGN)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<pre><code>Error in `mutate()`:
ℹ In argument: `lang_diff = ifelse(LANGN == LANGTEST_QQQ, FALSE, TRUE)`.
Caused by error in `Ops.factor()`:
! level sets of factors are different</code></pre>
</div>
</div>
<p>The levels in each field are different, i.e.&nbsp;the range of home languages is larger than the range of test languages. To fix this, all we need to do is change the datatype of the factors <code>LANGN</code> and <code>LANGTEST_QQQ</code> to characters using <code>as.character(&lt;field&gt;)</code>. This will then allow the comparison of the text stored in each row:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1"></a>lang_data <span class="ot">&lt;-</span> PISA_2022 <span class="sc">%&gt;%</span></span>
<span id="cb74-2"><a href="#cb74-2"></a>  <span class="fu">mutate</span>(<span class="at">lang_diff =</span> </span>
<span id="cb74-3"><a href="#cb74-3"></a>           <span class="fu">ifelse</span>(<span class="fu">as.character</span>(LANGN) <span class="sc">==</span> <span class="fu">as.character</span>(LANGTEST_QQQ),</span>
<span id="cb74-4"><a href="#cb74-4"></a>                  <span class="cn">FALSE</span>, </span>
<span id="cb74-5"><a href="#cb74-5"></a>                  <span class="cn">TRUE</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb74-6"><a href="#cb74-6"></a>  <span class="fu">select</span>(CNT, lang_diff, LANGTEST_QQQ, LANGN)</span>
<span id="cb74-7"><a href="#cb74-7"></a></span>
<span id="cb74-8"><a href="#cb74-8"></a><span class="fu">print</span>(lang_data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 613,744 × 4
   CNT     lang_diff LANGTEST_QQQ LANGN   
   &lt;fct&gt;   &lt;lgl&gt;     &lt;fct&gt;        &lt;fct&gt;   
 1 Albania FALSE     Albanian     Albanian
 2 Albania FALSE     Albanian     Albanian
 3 Albania FALSE     Albanian     Albanian
 4 Albania FALSE     Albanian     Albanian
 5 Albania FALSE     Albanian     Albanian
 6 Albania FALSE     Albanian     Albanian
 7 Albania FALSE     Albanian     Albanian
 8 Albania FALSE     Albanian     Albanian
 9 Albania FALSE     Albanian     Albanian
10 Albania FALSE     Albanian     Albanian
# ℹ 613,734 more rows</code></pre>
</div>
</div>
<p>We can now look at this dataset to get an idea of which countries have the largest percentage of students learning in a language other than their mother tongue:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb76-1"><a href="#cb76-1"></a>lang_data_diff <span class="ot">&lt;-</span> lang_data <span class="sc">%&gt;%</span> </span>
<span id="cb76-2"><a href="#cb76-2"></a>  <span class="fu">group_by</span>(CNT) <span class="sc">%&gt;%</span></span>
<span id="cb76-3"><a href="#cb76-3"></a>  <span class="fu">mutate</span>(<span class="at">student_n =</span> <span class="fu">n</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb76-4"><a href="#cb76-4"></a>  <span class="fu">group_by</span>(CNT, lang_diff) <span class="sc">%&gt;%</span></span>
<span id="cb76-5"><a href="#cb76-5"></a>  <span class="fu">summarise</span>(<span class="at">n =</span> <span class="fu">n</span>(),</span>
<span id="cb76-6"><a href="#cb76-6"></a>            <span class="at">percentage =</span> <span class="dv">100</span><span class="sc">*</span>(n <span class="sc">/</span> <span class="fu">max</span>(student_n))) <span class="sc">%&gt;%</span></span>
<span id="cb76-7"><a href="#cb76-7"></a>    <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(lang_diff),</span>
<span id="cb76-8"><a href="#cb76-8"></a>         lang_diff <span class="sc">==</span> <span class="cn">TRUE</span>)</span>
<span id="cb76-9"><a href="#cb76-9"></a></span>
<span id="cb76-10"><a href="#cb76-10"></a><span class="fu">print</span>(lang_data_diff)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 80 × 4
# Groups:   CNT [80]
   CNT                  lang_diff     n percentage
   &lt;fct&gt;                &lt;lgl&gt;     &lt;int&gt;      &lt;dbl&gt;
 1 Albania              TRUE        720      11.7 
 2 United Arab Emirates TRUE      13933      56.6 
 3 Argentina            TRUE        788       6.51
 4 Australia            TRUE       1827      13.6 
 5 Austria              TRUE       1455      23.7 
 6 Belgium              TRUE       2445      29.5 
 7 Bulgaria             TRUE        961      15.7 
 8 Brazil               TRUE        559       5.18
 9 Brunei Darussalam    TRUE       4831      86.6 
10 Canada               TRUE       5971      25.9 
# ℹ 70 more rows</code></pre>
</div>
</div>
<p>This looks like a promising dataset, but there are some strange results:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb78-1"><a href="#cb78-1"></a>lang_data_diff <span class="sc">%&gt;%</span> <span class="fu">filter</span>(percentage <span class="sc">&gt;</span> <span class="dv">92</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 8 × 4
# Groups:   CNT [8]
  CNT                          lang_diff     n percentage
  &lt;fct&gt;                        &lt;lgl&gt;     &lt;int&gt;      &lt;dbl&gt;
1 Hong Kong (China)            TRUE       5626       95.2
2 Macao (China)                TRUE       4384      100  
3 Montenegro                   TRUE       5596       96.6
4 Norway                       TRUE       6611      100  
5 Philippines                  TRUE       6693       93.0
6 Ukrainian regions (18 of 27) TRUE       3747       96.7
7 Singapore                    TRUE       6567       99.4
8 Chinese Taipei               TRUE       5821       99.4</code></pre>
</div>
</div>
<p>Exploring data for Ukraine, we can see that a different spelling has been used in each field, <em>Ukra</em><u>i</u>nian and <em>Ukranain</em>, an incorrect spelling.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb80-1"><a href="#cb80-1"></a>lang_data <span class="sc">%&gt;%</span> <span class="fu">filter</span>(CNT <span class="sc">==</span> <span class="st">"Ukrainian regions (18 of 27)"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3,876 × 4
   CNT                          lang_diff LANGTEST_QQQ LANGN    
   &lt;fct&gt;                        &lt;lgl&gt;     &lt;fct&gt;        &lt;fct&gt;    
 1 Ukrainian regions (18 of 27) TRUE      Ukranian     Ukrainian
 2 Ukrainian regions (18 of 27) TRUE      Ukranian     Ukrainian
 3 Ukrainian regions (18 of 27) TRUE      Ukranian     Russian  
 4 Ukrainian regions (18 of 27) TRUE      Ukranian     Ukrainian
 5 Ukrainian regions (18 of 27) TRUE      Ukranian     Ukrainian
 6 Ukrainian regions (18 of 27) TRUE      Ukranian     Ukrainian
 7 Ukrainian regions (18 of 27) TRUE      Ukranian     Russian  
 8 Ukrainian regions (18 of 27) TRUE      Ukranian     Ukrainian
 9 Ukrainian regions (18 of 27) TRUE      Ukranian     Ukrainian
10 Ukrainian regions (18 of 27) TRUE      Ukranian     Ukrainian
# ℹ 3,866 more rows</code></pre>
</div>
</div>
<p><code>ifelse</code> can help here too. If we pick the spelling we want to stick to, we can <em>recode</em> fields to match:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb82-1"><a href="#cb82-1"></a>lang_data <span class="sc">%&gt;%</span> </span>
<span id="cb82-2"><a href="#cb82-2"></a>  <span class="fu">mutate</span>(<span class="at">LANGTEST_QQQ =</span> </span>
<span id="cb82-3"><a href="#cb82-3"></a>           <span class="fu">ifelse</span>(<span class="fu">as.character</span>(LANGTEST_QQQ) <span class="sc">==</span> <span class="st">"Ukranian"</span>,</span>
<span id="cb82-4"><a href="#cb82-4"></a>                 <span class="st">"Ukrainian"</span>,</span>
<span id="cb82-5"><a href="#cb82-5"></a>                 <span class="fu">as.character</span>(LANGTEST_QQQ))) <span class="sc">%&gt;%</span></span>
<span id="cb82-6"><a href="#cb82-6"></a>  <span class="fu">mutate</span>(<span class="at">lang_diff =</span> </span>
<span id="cb82-7"><a href="#cb82-7"></a>           <span class="fu">ifelse</span>(<span class="fu">as.character</span>(LANGN) <span class="sc">==</span> <span class="fu">as.character</span>(LANGTEST_QQQ),</span>
<span id="cb82-8"><a href="#cb82-8"></a>                  <span class="cn">FALSE</span>, </span>
<span id="cb82-9"><a href="#cb82-9"></a>                  <span class="cn">TRUE</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb82-10"><a href="#cb82-10"></a>  <span class="fu">filter</span>(CNT <span class="sc">==</span> <span class="st">"Ukrainian regions (18 of 27)"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3,876 × 4
   CNT                          lang_diff LANGTEST_QQQ LANGN    
   &lt;fct&gt;                        &lt;lgl&gt;     &lt;chr&gt;        &lt;fct&gt;    
 1 Ukrainian regions (18 of 27) FALSE     Ukrainian    Ukrainian
 2 Ukrainian regions (18 of 27) FALSE     Ukrainian    Ukrainian
 3 Ukrainian regions (18 of 27) TRUE      Ukrainian    Russian  
 4 Ukrainian regions (18 of 27) FALSE     Ukrainian    Ukrainian
 5 Ukrainian regions (18 of 27) FALSE     Ukrainian    Ukrainian
 6 Ukrainian regions (18 of 27) FALSE     Ukrainian    Ukrainian
 7 Ukrainian regions (18 of 27) TRUE      Ukrainian    Russian  
 8 Ukrainian regions (18 of 27) FALSE     Ukrainian    Ukrainian
 9 Ukrainian regions (18 of 27) FALSE     Ukrainian    Ukrainian
10 Ukrainian regions (18 of 27) FALSE     Ukrainian    Ukrainian
# ℹ 3,866 more rows</code></pre>
</div>
</div>
<p>Unfortunately, if you explore this dataset a little further, the language fields don’t conform well with each other and a lot more work with <code>ifelse</code> will be needed before you could put together any full analysis around students who speak different languages at home and at school.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>It’s possible to nest our <code>ifelse</code> statements, by writing another <code>ifelse</code> where you would have the <code>&lt;value_if_false&gt;</code>, for example we might want to give describe the type of school in England:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb84-1"><a href="#cb84-1"></a><span class="co"># </span><span class="al">TODO</span><span class="co">: use PISA for this</span></span>
<span id="cb84-2"><a href="#cb84-2"></a>plot_data <span class="ot">&lt;-</span> schools <span class="sc">%&gt;%</span> </span>
<span id="cb84-3"><a href="#cb84-3"></a>  <span class="fu">mutate</span>(<span class="at">sch_type =</span> </span>
<span id="cb84-4"><a href="#cb84-4"></a>           <span class="fu">ifelse</span>(EstablishmentGroup <span class="sc">==</span> <span class="st">"Special schools"</span>, <span class="st">"Special"</span>,</span>
<span id="cb84-5"><a href="#cb84-5"></a>                  <span class="fu">ifelse</span>(EstablishmentGroup <span class="sc">==</span> <span class="st">"Independent schools"</span>, <span class="st">"Independent"</span>,</span>
<span id="cb84-6"><a href="#cb84-6"></a>                         <span class="fu">ifelse</span>(AdmissionsPolicy<span class="sc">==</span><span class="st">"Selective"</span>, </span>
<span id="cb84-7"><a href="#cb84-7"></a>                                <span class="st">"Grammar"</span>, <span class="st">"Comprehensive"</span>))))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</section>
<section id="sec-factors" class="level2" data-number="8.2">
<h2 data-number="8.2" class="anchored" data-anchor-id="sec-factors"><span class="header-section-number">8.2</span> Factors and statistical data types</h2>
<p>The types of variable will heavily influence what statistical analysis you can perform, e.g.&nbsp;you’ll need numeric values for a t-test. R is there to help by assigning datatypes to each field. We have different sorts of data that can be stored:</p>
<!-- https://www150.statcan.gc.ca/n1/edu/power-pouvoir/ch8/5214817-eng.htm -->
<ul>
<li><strong>Categorical</strong> - data that can be divided into groups or categories
<ul>
<li><strong>Nominal</strong> - categorical data where the order isn’t important, e.g.&nbsp;gender, or colours</li>
<li><strong>Ordinal</strong> - categorical data that may have order or ranking, e.g.&nbsp;exam grades (A, B, C, D) or lickert scales (strongly agree, agree, disgaree, strongly disagree)</li>
</ul></li>
<li><strong>Numeric</strong> - data that consists of numbers
<ul>
<li><strong>Continuous</strong> - numeric data that can take any value within a given range, e.g.&nbsp;height (178cm, 134.54cm)</li>
<li><strong>Discrete</strong> - numeric data that can take only certain values within a range, e.g.&nbsp;number of children in a family (0,1,2,3,4,5)</li>
</ul></li>
</ul>
<p>But here we are going to look at how R handles <code>factors</code>. Factors have two parts, <code>levels</code> and <code>codes</code>. levels are what you see when you view a table column, codes are an underlying order to the data. Factors allow you to store data that has a known set of values that you might want to display in an order other than alphabetical. For example, if we look at the month field <code>ST003D02T</code> using the <code>levels(&lt;field&gt;)</code> command:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb85-1"><a href="#cb85-1"></a><span class="fu">levels</span>(PISA_2022<span class="sc">$</span>ST003D02T)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "January"        "February"       "March"          "April"         
 [5] "May"            "June"           "July"           "August"        
 [9] "September"      "October"        "November"       "December"      
[13] "Valid Skip"     "Not Applicable" "Invalid"        "No Response"   </code></pre>
</div>
</div>
<p>We can see that the months of the year are there along with other possible <code>levels</code>. With this particular column there are levels for missing or wrong responses (“Valid Skip”, “Not Applicable” “Invalid”, “No Response”), though PISA rarely uses them. You are more likely to find that missing/wrong data items are coded as <code>NA</code>, as you can see below:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb87"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb87-1"><a href="#cb87-1"></a>PISA_2022 <span class="sc">%&gt;%</span> <span class="fu">count</span>(ST003D02T)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 13 × 2
   ST003D02T     n
   &lt;fct&gt;     &lt;int&gt;
 1 January   48760
 2 February  43030
 3 March     48671
 4 April     47014
 5 May       49235
 6 June      48890
 7 July      51262
 8 August    51681
 9 September 51755
10 October   51703
11 November  48179
12 December  48156
13 &lt;NA&gt;      25408</code></pre>
</div>
</div>
<p><code>Codes</code> are the underlying numbers/order for each level, in this case <code>1 = January</code>, <code>2 = February</code>, etc. R stores factors as codes, then uses the <code>levels</code> to display the data. You can see the <em>codes</em> by using the <code>as.numeric</code> command on a factor:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb89"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb89-1"><a href="#cb89-1"></a><span class="fu">as.numeric</span>(PISA_2022<span class="sc">$</span>ST003D02T)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1]  5  2  8  7  1  5  5 12  8  9 10  4  5  8  7  2  3  6  3  8 10  1 10  2  5
[26]  6  8  1  3  2  5  7 12  4  1 10 10  3  3  9
 [ reached getOption("max.print") -- omitted 613704 entries ]</code></pre>
</div>
</div>
<p>How can this be useful? Firstly it’s more efficient for R to store data this way, numbers (codes) are smaller and easier to sort/search than text (levels). But it also helps when we come to presenting data. A good example is how plots are made, they will use the <code>codes</code> to give an order to the display of columns, in the plot below, <code>February</code> (<code>2</code>) comes before <code>August</code> (<code>8</code>), even though there were more students born in <code>August</code> and <em>A</em> is before <em>F</em> in the alphabet:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb91"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb91-1"><a href="#cb91-1"></a>grph_data <span class="ot">&lt;-</span> PISA_2022 <span class="sc">%&gt;%</span> </span>
<span id="cb91-2"><a href="#cb91-2"></a>         <span class="fu">group_by</span>(ST003D02T) <span class="sc">%&gt;%</span> </span>
<span id="cb91-3"><a href="#cb91-3"></a>         <span class="fu">summarise</span>(<span class="at">n=</span><span class="fu">n</span>())</span>
<span id="cb91-4"><a href="#cb91-4"></a></span>
<span id="cb91-5"><a href="#cb91-5"></a>grph_data <span class="sc">%&gt;%</span> <span class="fu">arrange</span>(<span class="fu">desc</span>(n)) <span class="sc">%&gt;%</span> <span class="fu">pull</span>(ST003D02T)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] September October   August    July      May       June      January  
 [8] March     November  December  April     February  &lt;NA&gt;     
attr(,"label")
[1] Student (Standardized) Birth - Month
16 Levels: January February March April May June July August ... No Response</code></pre>
</div>
<div class="sourceCode cell-code" id="cb93"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb93-1"><a href="#cb93-1"></a><span class="fu">ggplot</span>(<span class="at">data=</span>grph_data, <span class="fu">aes</span>(<span class="at">x=</span>ST003D02T, <span class="at">y=</span>n)) <span class="sc">+</span> </span>
<span id="cb93-2"><a href="#cb93-2"></a>  <span class="fu">geom_bar</span>(<span class="at">stat =</span> <span class="st">"identity"</span>) <span class="sc">+</span></span>
<span id="cb93-3"><a href="#cb93-3"></a>  <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">45</span>, <span class="at">hjust =</span> <span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="02-3-Intro_to_analysis_software_files/figure-html/unnamed-chunk-66-1.png" class="img-fluid figure-img" style="width:95.0%"></p>
</figure>
</div>
</div>
</div>
<p>To re-order the columns to match the number of students in each month, we can either try to do this manually, which is rather cumbersome:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb94"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb94-1"><a href="#cb94-1"></a>my_levels <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"September"</span>, <span class="st">"October"</span>, <span class="st">"August"</span>, <span class="st">"July"</span>, <span class="st">"May"</span>, <span class="st">"June"</span>, </span>
<span id="cb94-2"><a href="#cb94-2"></a>               <span class="st">"January"</span>, <span class="st">"March"</span>, <span class="st">"November"</span>, <span class="st">"December"</span>, <span class="st">"April"</span>, <span class="st">"February"</span>,</span>
<span id="cb94-3"><a href="#cb94-3"></a>               <span class="st">"Valid Skip"</span>, <span class="st">"Not Applicable"</span>, <span class="st">"Invalid"</span>, <span class="st">"No Response"</span>)</span>
<span id="cb94-4"><a href="#cb94-4"></a></span>
<span id="cb94-5"><a href="#cb94-5"></a>grph_data<span class="sc">$</span>ST003D02T <span class="ot">&lt;-</span> <span class="fu">factor</span>(grph_data<span class="sc">$</span>ST003D02T, <span class="at">levels=</span>my_levels)</span>
<span id="cb94-6"><a href="#cb94-6"></a></span>
<span id="cb94-7"><a href="#cb94-7"></a><span class="fu">ggplot</span>(<span class="at">data=</span>grph_data, <span class="fu">aes</span>(<span class="at">x=</span>ST003D02T, <span class="at">y=</span>n)) <span class="sc">+</span> </span>
<span id="cb94-8"><a href="#cb94-8"></a>  <span class="fu">geom_bar</span>(<span class="at">stat =</span> <span class="st">"identity"</span>)<span class="sc">+</span></span>
<span id="cb94-9"><a href="#cb94-9"></a>  <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">45</span>, <span class="at">hjust =</span> <span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="02-3-Intro_to_analysis_software_files/figure-html/unnamed-chunk-67-1.png" class="img-fluid figure-img" style="width:95.0%"></p>
</figure>
</div>
</div>
</div>
<p>Or we can get R to do this for us:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb95"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb95-1"><a href="#cb95-1"></a><span class="co"># get the levels in order and pull/create a vector of them</span></span>
<span id="cb95-2"><a href="#cb95-2"></a>my_levels <span class="ot">&lt;-</span> grph_data <span class="sc">%&gt;%</span> <span class="fu">arrange</span>(<span class="fu">desc</span>(n)) <span class="sc">%&gt;%</span> <span class="fu">pull</span>(ST003D02T)</span>
<span id="cb95-3"><a href="#cb95-3"></a></span>
<span id="cb95-4"><a href="#cb95-4"></a><span class="co"># reassign the re-ordered levels to the dataframe column</span></span>
<span id="cb95-5"><a href="#cb95-5"></a>grph_data<span class="sc">$</span>ST003D02T <span class="ot">&lt;-</span> <span class="fu">factor</span>(grph_data<span class="sc">$</span>ST003D02T, <span class="at">levels=</span>my_levels)</span>
<span id="cb95-6"><a href="#cb95-6"></a></span>
<span id="cb95-7"><a href="#cb95-7"></a><span class="fu">ggplot</span>(<span class="at">data=</span>grph_data, <span class="fu">aes</span>(<span class="at">x=</span>ST003D02T, <span class="at">y=</span>n)) <span class="sc">+</span> </span>
<span id="cb95-8"><a href="#cb95-8"></a>  <span class="fu">geom_bar</span>(<span class="at">stat =</span> <span class="st">"identity"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="02-3-Intro_to_analysis_software_files/figure-html/unnamed-chunk-68-1.png" class="img-fluid figure-img" style="width:95.0%"></p>
</figure>
</div>
</div>
</div>
<p>To learn a lot more about factors, see <a href="https://r4ds.had.co.nz/factors.html">Hadley’s chapter</a></p>
</section>
</section>
<section id="seminar-tasks" class="level1" data-number="9">
<h1 data-number="9"><span class="header-section-number">9</span> Seminar tasks</h1>
<section id="student-dataset" class="level2" data-number="9.1">
<h2 data-number="9.1" class="anchored" data-anchor-id="student-dataset"><span class="header-section-number">9.1</span> Student dataset</h2>
<div class="question">
<ol type="1">
<li>How many unique values are there in the <code>OCOD3</code> field for student intended future occupation? How does the most desired career vary by gender?</li>
</ol>
<div class="cell">
<details class="code-fold">
<summary>answer</summary>
<div class="sourceCode cell-code" id="cb96"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb96-1"><a href="#cb96-1"></a>PISA_2022<span class="sc">$</span>OCOD3 <span class="sc">%&gt;%</span> <span class="fu">unique</span>() <span class="sc">%&gt;%</span> <span class="fu">length</span>()</span>
<span id="cb96-2"><a href="#cb96-2"></a></span>
<span id="cb96-3"><a href="#cb96-3"></a>PISA_2022 <span class="sc">%&gt;%</span> </span>
<span id="cb96-4"><a href="#cb96-4"></a>  <span class="fu">group_by</span>(ST004D01T, OCOD3) <span class="sc">%&gt;%</span></span>
<span id="cb96-5"><a href="#cb96-5"></a>  <span class="fu">summarise</span>(<span class="at">n =</span><span class="fu">n</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb96-6"><a href="#cb96-6"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(n))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<ol start="2" type="1">
<li>write code to work out the <code>mean</code> and <code>median</code> <code>PV1MATH</code> score for each country <code>CNT</code>.</li>
</ol>
<div class="cell">
<details class="code-fold">
<summary>answer</summary>
<div class="sourceCode cell-code" id="cb97"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb97-1"><a href="#cb97-1"></a>PISA_2022 <span class="sc">%&gt;%</span> </span>
<span id="cb97-2"><a href="#cb97-2"></a>  <span class="fu">group_by</span>(CNT) <span class="sc">%&gt;%</span></span>
<span id="cb97-3"><a href="#cb97-3"></a>  <span class="fu">summarise</span>(<span class="at">mean_PV1MATH =</span> <span class="fu">mean</span>(PV1MATH, <span class="at">na.rm=</span><span class="cn">TRUE</span>),</span>
<span id="cb97-4"><a href="#cb97-4"></a>            <span class="at">median_PV1MATH =</span> <span class="fu">median</span>(PV1MATH, <span class="at">na.rm=</span><span class="cn">TRUE</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb97-5"><a href="#cb97-5"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(median_PV1MATH))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<ol start="3" type="1">
<li>what is the fourth most popular language at home <code>LANGN</code> spoken by students in schools in the <code>Ireland</code>, how does this compare to <code>Germany</code>?</li>
</ol>
<div class="cell">
<details class="code-fold">
<summary>answer</summary>
<div class="sourceCode cell-code" id="cb98"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb98-1"><a href="#cb98-1"></a>PISA_2022 <span class="sc">%&gt;%</span> </span>
<span id="cb98-2"><a href="#cb98-2"></a>  <span class="fu">filter</span>(CNT <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Germany"</span>, <span class="st">"Ireland"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb98-3"><a href="#cb98-3"></a>  <span class="fu">group_by</span>(CNT, LANGN) <span class="sc">%&gt;%</span></span>
<span id="cb98-4"><a href="#cb98-4"></a>  <span class="fu">summarise</span>(<span class="at">n =</span> <span class="fu">n</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb98-5"><a href="#cb98-5"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(n))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<ol start="4" type="1">
<li>Spot the <strong>five</strong> errors with the following code. Can you make it work? What does it do?</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb99"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb99-1"><a href="#cb99-1"></a><span class="co"># Work out when science scores are better than maths</span></span>
<span id="cb99-2"><a href="#cb99-2"></a>PISA_2022_scimath <span class="sc">&lt;</span> PISA_2022 <span class="sc">%&gt;%</span></span>
<span id="cb99-3"><a href="#cb99-3"></a>  <span class="fu">rename</span>(<span class="at">gender =</span> ST004D01T) <span class="sc">%&gt;%</span></span>
<span id="cb99-4"><a href="#cb99-4"></a>  <span class="fu">mutate</span>(sci <span class="at">better =</span> PV1SCIE <span class="sc">-</span> PV1MATH) <span class="sc">%&gt;%</span></span>
<span id="cb99-5"><a href="#cb99-5"></a>  <span class="fu">filter</span>(<span class="fu">is.na</span>(scibetter) <span class="sc">%&gt;%</span></span>
<span id="cb99-6"><a href="#cb99-6"></a>  <span class="fu">group_by</span>(CNT gender) <span class="sc">%&gt;%</span></span>
<span id="cb99-7"><a href="#cb99-7"></a>  <span class="fu">summarise</span>(<span class="at">students =</span> n,</span>
<span id="cb99-8"><a href="#cb99-8"></a>            <span class="at">sci_win =</span> <span class="fu">sum</span>(scibetter <span class="sc">&gt;=</span> <span class="dv">0</span>),</span>
<span id="cb99-9"><a href="#cb99-9"></a>            <span class="at">per_scibetter =</span> <span class="dv">100</span><span class="sc">*</span>(sci_win<span class="sc">/</span>students))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<details class="code-fold">
<summary>answer</summary>
<div class="sourceCode cell-code" id="cb100"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb100-1"><a href="#cb100-1"></a><span class="co"># Work out when more time spent in language lessons than maths lessons</span></span>
<span id="cb100-2"><a href="#cb100-2"></a>PISA_2022_scimath <span class="ot">&lt;-</span> PISA_2022 <span class="sc">%&gt;%</span>  <span class="co">#1 make sure you have the assignment arrow &lt;-</span></span>
<span id="cb100-3"><a href="#cb100-3"></a>  <span class="fu">rename</span>(<span class="at">gender =</span> ST004D01T) <span class="sc">%&gt;%</span></span>
<span id="cb100-4"><a href="#cb100-4"></a>  <span class="fu">mutate</span>(<span class="at">sci_better =</span> PV1MATH <span class="sc">-</span> PV1SCIE) <span class="sc">%&gt;%</span> <span class="co">#2 _ not space in name of field</span></span>
<span id="cb100-5"><a href="#cb100-5"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(sci_better)) <span class="sc">%&gt;%</span>  <span class="co">#3 this needs to be !is.na, otherwise it'll return nothing</span></span>
<span id="cb100-6"><a href="#cb100-6"></a>  <span class="fu">group_by</span>(CNT, gender) <span class="sc">%&gt;%</span> <span class="co">#4 missing comma</span></span>
<span id="cb100-7"><a href="#cb100-7"></a>  <span class="fu">summarise</span>(<span class="at">students =</span> <span class="fu">n</span>(),   <span class="co">#5 missing brackets on the n() command</span></span>
<span id="cb100-8"><a href="#cb100-8"></a>            <span class="at">sci_win =</span> <span class="fu">sum</span>(sci_better <span class="sc">&gt;=</span> <span class="dv">0</span>),</span>
<span id="cb100-9"><a href="#cb100-9"></a>            <span class="at">per_sci_win =</span> <span class="dv">100</span><span class="sc">*</span>(sci_win<span class="sc">/</span>students))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<ol start="5" type="1">
<li>By country and gender work out the mean, median and standard deviations of <code>STUBMI</code>, order by the descending <code>mean</code>.</li>
</ol>
<div class="cell">
<details class="code-fold">
<summary>answer</summary>
<div class="sourceCode cell-code" id="cb101"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb101-1"><a href="#cb101-1"></a>pisa_bmi <span class="ot">&lt;-</span> PISA_2022 <span class="sc">%&gt;%</span></span>
<span id="cb101-2"><a href="#cb101-2"></a>  <span class="fu">rename</span>(<span class="at">gender =</span> ST004D01T) <span class="sc">%&gt;%</span></span>
<span id="cb101-3"><a href="#cb101-3"></a>  <span class="fu">group_by</span>(CNT, gender) <span class="sc">%&gt;%</span></span>
<span id="cb101-4"><a href="#cb101-4"></a>  <span class="fu">summarise</span>(<span class="at">n=</span><span class="fu">n</span>(),</span>
<span id="cb101-5"><a href="#cb101-5"></a>            <span class="at">bmi_mean =</span> <span class="fu">mean</span>(STUBMI, <span class="at">na.rm=</span><span class="cn">TRUE</span>),</span>
<span id="cb101-6"><a href="#cb101-6"></a>            <span class="at">bmi_median =</span> <span class="fu">median</span>(STUBMI, <span class="at">na.rm=</span><span class="cn">TRUE</span>),</span>
<span id="cb101-7"><a href="#cb101-7"></a>            <span class="at">bmi_sd =</span> <span class="fu">sd</span>(STUBMI, <span class="at">na.rm=</span><span class="cn">TRUE</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb101-8"><a href="#cb101-8"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(bmi_mean))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
</section>
<section id="teacher-dataset" class="level2" data-number="9.2">
<h2 data-number="9.2" class="anchored" data-anchor-id="teacher-dataset"><span class="header-section-number">9.2</span> Teacher dataset</h2>
<p>To further check your understanding of this section you will be attempting to analyse the 2022 teacher dataset. This dataset includes records for 68054 teachers from 18 countries, including 544 columns, covering attitudinal, demographic and workplace data. You can find the dataset <a href="https://emckclac-my.sharepoint.com/:u:/g/personal/k1926273_kcl_ac_uk/EbFmgVVbQD9DlIIgOKHDhLcB8bA8lfQMDVSEkcjtByM2cQ?e=zYG4Is">here</a> in the <code>.parquet</code> format.</p>
<div class="cell">
<details class="code-fold">
<summary>example loading code</summary>
<div class="sourceCode cell-code" id="cb102"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb102-1"><a href="#cb102-1"></a><span class="co"># download the file then</span></span>
<span id="cb102-2"><a href="#cb102-2"></a><span class="co"># Work out when more time spent in language lessons than maths lessons</span></span>
<span id="cb102-3"><a href="#cb102-3"></a>PISA_2022_teacher <span class="ot">&lt;-</span> <span class="fu">read_parquet</span>(<span class="st">"C:/Users/Peter/Downloads/PISA_2012_teacher.parquet"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="question">
<ol type="1">
<li>Work out how many teachers are in the dataset for <code>Portugal</code></li>
</ol>
<div class="cell">
<details class="code-fold">
<summary>answer</summary>
<div class="sourceCode cell-code" id="cb103"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb103-1"><a href="#cb103-1"></a>PISA_2022_teacher <span class="sc">%&gt;%</span> </span>
<span id="cb103-2"><a href="#cb103-2"></a>  <span class="fu">group_by</span>(CNTRYID) <span class="sc">%&gt;%</span></span>
<span id="cb103-3"><a href="#cb103-3"></a>  <span class="fu">summarise</span>(<span class="at">n=</span><span class="fu">n</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb103-4"><a href="#cb103-4"></a>  <span class="fu">filter</span>(CNTRYID <span class="sc">==</span> <span class="st">"Portugal"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<ol start="2" type="1">
<li>For each country <code>CNTRYID</code> by gender <code>TC001Q01NA</code>, what is the <code>mean</code> time that a teacher has been in the teaching profession <code>TC007Q02NA</code>? Include the number of teachers in each group. Order this to show the country with the longest serving workforce:</li>
</ol>
<div class="cell">
<details class="code-fold">
<summary>answer</summary>
<div class="sourceCode cell-code" id="cb104"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb104-1"><a href="#cb104-1"></a>PISA_2022_teacher <span class="sc">%&gt;%</span></span>
<span id="cb104-2"><a href="#cb104-2"></a>  <span class="fu">group_by</span>(CNTRYID, TC001Q01NA) <span class="sc">%&gt;%</span></span>
<span id="cb104-3"><a href="#cb104-3"></a>  <span class="fu">summarise</span>(<span class="at">avg_years =</span> <span class="fu">mean</span>(TC007Q02NA, <span class="at">na.rm=</span><span class="cn">TRUE</span>),</span>
<span id="cb104-4"><a href="#cb104-4"></a>            <span class="at">n =</span> <span class="fu">n</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb104-5"><a href="#cb104-5"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(avg_years))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<ol start="3" type="1">
<li>For each country <code>CNT</code> find out which teachers report that they ‘Help students think critically’ <code>TC199Q07HA</code>. Hin: you’ll need to look at the levels of this question to find the correct filter:</li>
</ol>
<div class="cell">
<details class="code-fold">
<summary>answer</summary>
<div class="sourceCode cell-code" id="cb105"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb105-1"><a href="#cb105-1"></a>crit_thinking <span class="ot">&lt;-</span> PISA_2022_teacher <span class="sc">%&gt;%</span> </span>
<span id="cb105-2"><a href="#cb105-2"></a>  <span class="fu">rename</span>(<span class="at">crit_think =</span> TC199Q07HA) <span class="sc">%&gt;%</span></span>
<span id="cb105-3"><a href="#cb105-3"></a>  <span class="fu">group_by</span>(CNT) <span class="sc">%&gt;%</span></span>
<span id="cb105-4"><a href="#cb105-4"></a>  <span class="fu">mutate</span>(<span class="at">teachers=</span><span class="fu">n</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb105-5"><a href="#cb105-5"></a>  <span class="fu">group_by</span>(CNT, crit_think) <span class="sc">%&gt;%</span></span>
<span id="cb105-6"><a href="#cb105-6"></a>  <span class="fu">summarise</span>(<span class="at">n =</span> <span class="fu">n</span>(),</span>
<span id="cb105-7"><a href="#cb105-7"></a>            <span class="at">per =</span> <span class="fu">n</span>()<span class="sc">/</span><span class="fu">unique</span>(teachers)) <span class="sc">%&gt;%</span></span>
<span id="cb105-8"><a href="#cb105-8"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(per)) <span class="sc">%&gt;%</span></span>
<span id="cb105-9"><a href="#cb105-9"></a>  <span class="fu">filter</span>(crit_think <span class="sc">==</span> <span class="st">"A lot"</span>)</span>
<span id="cb105-10"><a href="#cb105-10"></a></span>
<span id="cb105-11"><a href="#cb105-11"></a><span class="co"># interestingly the highest performing countries also </span></span>
<span id="cb105-12"><a href="#cb105-12"></a><span class="co"># have some of the lowest scores in helping children </span></span>
<span id="cb105-13"><a href="#cb105-13"></a><span class="co"># think critically. To plot this:</span></span>
<span id="cb105-14"><a href="#cb105-14"></a></span>
<span id="cb105-15"><a href="#cb105-15"></a><span class="fu">left_join</span>(crit_thinking,</span>
<span id="cb105-16"><a href="#cb105-16"></a>          PISA_2022 <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(CNT) <span class="sc">%&gt;%</span> <span class="fu">summarise</span>(<span class="at">maths =</span> <span class="fu">mean</span>(PV1MATH))) <span class="sc">%&gt;%</span></span>
<span id="cb105-17"><a href="#cb105-17"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x=</span>per, <span class="at">y=</span>maths)) <span class="sc">+</span> </span>
<span id="cb105-18"><a href="#cb105-18"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb105-19"><a href="#cb105-19"></a>  <span class="fu">geom_smooth</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<ol start="4" type="1">
<li>Explore the data on use of technology in the classroom <code>TC169____</code></li>
</ol>
<div class="cell">
<details class="code-fold">
<summary>answer</summary>
<div class="sourceCode cell-code" id="cb106"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb106-1"><a href="#cb106-1"></a>PISA_2022_teacher <span class="sc">%&gt;%</span> <span class="fu">select</span>(CNT, TC001Q01NA, <span class="fu">starts_with</span>(<span class="st">"TC169"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<ol start="5" type="1">
<li><p>Save the results of one of the above questions using <code>write_csv()</code>.</p></li>
<li><p>[EXTENSION] explore the dataset and find out some more interesting facts to share with your group</p></li>
</ol>
</div>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>